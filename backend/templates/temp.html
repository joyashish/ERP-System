{% include 'header.html' %}
{% include 'navbar.html' %}
{% include 'sidebar.html' %}
{% load static %}

<div class="content-wrapper">
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-1">
        <div class="col-sm-6">
          <h1 class="m-0">Create Sale</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="{% url 'dash' %}">Home</a></li>
            <li class="breadcrumb-item active">Create Sale</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <section class="content">
    <div class="container-fluid">
      <div class="card" id="invoiceCard">
        <div class="card-header d-flex justify-content-between align-items-center py-1">
          <h3 class="card-title">New Sale</h3>
          <div>
            <button type="submit" form="saleForm" name="action" value="save" class="btn btn-success btn-sm mr-1">Save</button>
            <button type="submit" form="saleForm" name="action" value="save_new" class="btn btn-primary btn-sm mr-1">Save & New</button>
            <button type="button" class="btn btn-info btn-sm printButton" onclick="window.print();"><i class="fas fa-print"></i></button>
          </div>
        </div>
        <div class="card-body p-2">
          {% if messages %}
          <div class="alert alert-dismissible fade show" role="alert">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} py-1">
              <i class="fas fa-check-circle"></i> {{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">×</span>
              </button>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          <div class="invoice-header text-center d-none d-print-block">
            <h2>Sale Invoice</h2>
            <p class="small mb-0">Innobzeetech ERP System, Ranchi, Jharkhand</p>
          </div>

          <form id="saleForm" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
              <div class="col-md-8">
                <div class="card mb-2">
                  <div class="card-header py-1">Bill To</div>
                  <div class="card-body p-2">
                    <div class="row">
                      <div class="col-md-6 form-group mb-1">
                        <label for="partyName" required>Name *</label>
                        <input type="text" class="form-control form-control-sm" id="partyName" name="party_name" required>
                        <span class="d-none d-print-block party-name-print">{{ party_name|default:'____________________' }}</span>
                      </div>
                      <div class="col-md-6 form-group mb-1">
                        <label for="partyPhone">Phone</label>
                        <input type="text" class="form-control form-control-sm" id="partyPhone" name="party_phone">
                        <span class="d-none d-print-block party-phone-print">{{ party_phone|default:'____________________' }}</span>
                      </div>
                      <div class="col-md-6 form-group mb-1">
                        <label for="partyEmail">Email</label>
                        <input type="email" class="form-control form-control-sm" id="partyEmail" name="party_email">
                        <span class="d-none d-print-block party-email-print">{{ party_email|default:'____________________' }}</span>
                      </div>
                      <div class="col-md-6 form-group mb-1">
                        <label for="partyAddress">Address</label>
                        <textarea class="form-control form-control-sm" id="partyAddress" name="party_address" rows="2"></textarea>
                        <span class="d-none d-print-block party-address-print">{{ party_address|default:'____________________' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card mb-2">
                  <div class="card-header py-1">Invoice Details</div>
                  <div class="card-body p-2">
                    <div class="form-group mb-1">
                      <label for="invoiceNo" required>Invoice No *</label>
                      <input type="text" class="form-control form-control-sm" id="invoiceNo" name="invoice_no" value="{{ invoice_no }}" readonly>
                      <span class="d-none d-print-block invoice-no-print">{{ invoice_no }}</span>
                    </div>
                    <div class="form-group mb-1">
                      <label for="invoiceDate" required>Invoice Date *</label>
                      <input type="date" class="form-control form-control-sm" id="invoiceDate" name="invoice_date" value="{% now 'Y-m-d' %}" required>
                      <span class="d-none d-print-block invoice-date-print">{% now 'Y-m-d' %}</span>
                    </div>
                    <div class="form-group mb-1">
                      <label for="dueDate">Due Date</label>
                      <input type="date" class="form-control form-control-sm" id="dueDate" name="due_date">
                      <span class="d-none d-print-block due-date-print">{{ due_date|default:'____________________' }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card mb-2">
              <div class="card-header py-1">Items</div>
              <div class="card-body p-2">
                <table class="table table-bordered table-sm" id="itemTable">
                  <thead>
                    <tr>
                      <th style="width:5%">No</th>
                      <th style="width:25%">Item/Service</th>
                      <th style="width:10%">HSN/SAC</th>
                      <th style="width:10%">Batch</th>
                      <th style="width:10%">Expiry</th>
                      <th style="width:8%">Qty</th>
                      <th style="width:10%">Price</th>
                      <th style="width:8%">Disc</th>
                      <th style="width:10%">Tax</th>
                      <th style="width:14%">Amount</th>
                      <th style="width:5%" class="d-print-none"></th>
                    </tr>
                  </thead>
                  <tbody id="itemRows"></tbody>
                </table>
                <button type="button" class="btn btn-link btn-sm d-print-none" id="addItemBtn">+ Add Item</button>
                <div class="form-group mt-2 d-print-none">
                  <label for="barcode">Barcode</label>
                  <input type="text" class="form-control form-control-sm" id="barcode" placeholder="Enter barcode">
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="card mb-2">
                  <div class="card-header py-1">Notes & Terms</div>
                  <div class="card-body p-2">
                    <div class="form-group mb-1">
                      <label for="notes">Notes</label>
                      <textarea class="form-control form-control-sm" id="notes" name="notes" rows="2" placeholder="Add notes..."></textarea>
                      <span class="d-none d-print-block notes-print">{{ notes|default:'____________________' }}</span>
                    </div>
                    <div class="form-group mb-1">
                      <label for="terms">Terms</label>
                      <textarea class="form-control form-control-sm" id="terms" name="terms_conditions" rows="2">Goods once sold will not be taken back. Disputes subject to JHARKHAND jurisdiction.</textarea>
                      <span class="d-none d-print-block terms-print">Goods once sold will not be taken back. Disputes subject to JHARKHAND jurisdiction.</span>
                    </div>
                    <div class="form-group">
                      <label class="d-print-none">Bank Details</label>
                      <p class="mb-1 small">A/c: 5337777943, IFSC: CBIN0281583, Bank: Central Bank of India, CHANDRI</p>
                      <p class="mb-1 small">A/c Holder: Sanuj Kumar Gupta, UPI: 9122133687@axl</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card mb-2">
                  <div class="card-header py-1">Summary</div>
                  <div class="card-body p-2">
                    <div class="row mb-1">
                      <div class="col-6 small">Subtotal</div>
                      <div class="col-6 text-right small" id="subtotal">₹ 0.00</div>
                    </div>
                    <div class="row mb-1">
                      <div class="col-6 small">Discount</div>
                      <div class="col-6 text-right">
                        <input type="number" class="form-control form-control-sm d-inline-block w-50 d-print-none" id="totalDiscount" name="discount" value="0" step="0.01" min="0">
                        <span class="d-none d-print-block discount-print">0.00</span>
                      </div>
                    </div>
                    <div class="row mb-1">
                      <div class="col-6 small">Charges</div>
                      <div class="col-6 text-right">
                        <input type="number" class="form-control form-control-sm d-inline-block w-50 d-print-none" id="additionalCharges" name="additional_charges" value="0" step="0.01" min="0">
                        <span class="d-none d-print-block charges-print">0.00</span>
                      </div>
                    </div>
                    <div class="row mb-1">
                      <div class="col-6 small">Taxable Amount</div>
                      <div class="col-6 text-right small" id="taxableAmount">₹ 0.00</div>
                    </div>
                    <div class="row mb-1">
                      <div class="col-6 small">Total Tax</div>
                      <div class="col-6 text-right small" id="totalTax">₹ 0.00</div>
                    </div>
                    <div class="row mb-1">
                      <div class="col-6 small">Total Amount</div>
                      <div class="col-6 text-right small" id="totalAmount">₹ 0.00</div>
                    </div>
                    <div class="row mb-1">
                      <div class="col-6 small">Received</div>
                      <div class="col-6 text-right">
                        <input type="number" class="form-control form-control-sm d-inline-block w-50 d-print-none" id="amountReceived" name="amount_received" value="0" step="0.01" min="0">
                        <span class="d-none d-print-block received-print">0.00</span>
                      </div>
                    </div>
                    <div class="row mb-1">
                      <div class="col-6 small">Balance</div>
                      <div class="col-6 text-right small" id="balanceAmount">₹ 0.00</div>
                    </div>
                    <div class="row mt-1">
                      <div class="col-6 small d-print-none">Signature</div>
                      <div class="col-6 text-right d-print-none">
                        <input type="file" class="form-control-file form-control-sm" id="signature" name="signature">
                      </div>
                      <div class="col-12 text-right d-none d-print-block">
                        <span class="small">Authorized Signatory</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
</div>

<style>
  :root {
    --card-bg-light: #fff;
    --card-bg-dark: #2d3748;
    --border-color-light: #dee2e6;
    --border-color-dark: #4a5568;
    --text-color-light: #212529;
    --text-color-dark: #e2e8f0;
  }

  body.light-theme {
    background-color: #f8f9fa;
    color: var(--text-color-light);
  }

  body.dark-theme {
    background-color: #1a202c;
    color: var(--text-color-dark);
  }

  .card {
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .light-theme .card {
    background-color: var(--card-bg-light);
    border-color: var(--border-color-light);
  }

  .dark-theme .card {
    background-color: var(--card-bg-dark);
    border-color: var(--border-color-dark);
  }

  .card-header, .card-body {
    padding: 0.4rem !important;
  }

  .form-control-sm, .form-select-sm {
    font-size: 0.75rem;
    padding: 0.2rem 0.4rem;
    line-height: 1.4;
  }

  .table-sm th, .table-sm td {
    padding: 0.2rem;
    font-size: 0.75rem;
  }

  .form-control, .form-select {
    background-color: inherit;
    color: inherit;
    border-color: inherit;
  }

  .form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 0.15rem rgba(49, 130, 206, 0.25);
  }

  label {
    font-size: 0.75rem;
    color: inherit;
  }

  label[required]::after {
    content: " *";
    color: #dc3545;
  }

  .small {
    font-size: 0.75rem;
  }

  .select2-container .select2-selection--single {
    height: 28px;
    font-size: 0.75rem;
    border-color: inherit;
  }

  .select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 28px;
  }

  .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 28px;
  }

  @media print {
    body {
      background: #fff;
      color: #000;
      font-size: 9pt;
      margin: 0.3cm;
    }
    .content-wrapper, .card, .card-body {
      box-shadow: none;
      border: none;
      padding: 0;
      margin: 0;
    }
    .card-header, .printButton, #addItemBtn, .form-text, .btn, .alert, .d-print-none {
      display: none;
    }
    #invoiceCard {
      margin: 0;
      width: 100%;
    }
    #itemTable {
      width: 100%;
      border-collapse: collapse;
      margin: 5px 0;
    }
    #itemTable th, #itemTable td {
      border: 1px solid #000;
      padding: 2px;
      font-size: 9pt;
    }
    #itemTable th:nth-child(1), #itemTable td:nth-child(1) { width: 5%; }
    #itemTable th:nth-child(2), #itemTable td:nth-child(2) { width: 25%; }
    #itemTable th:nth-child(3), #itemTable td:nth-child(3) { width: 10%; }
    #itemTable th:nth-child(4), #itemTable td:nth-child(4) { width: 10%; }
    #itemTable th:nth-child(5), #itemTable td:nth-child(5) { width: 10%; }
    #itemTable th:nth-child(6), #itemTable td:nth-child(6) { width: 8%; }
    #itemTable th:nth-child(7), #itemTable td:nth-child(7) { width: 10%; }
    #itemTable th:nth-child(8), #itemTable td:nth-child(8) { width: 8%; }
    #itemTable th:nth-child(9), #itemTable td:nth-child(9) { width: 10%; }
    #itemTable th:nth-child(10), #itemTable td:nth-child(10) { width: 14%; }
    .form-control, .form-select, input, textarea, .select2-container {
      display: none;
    }
    .party-name-print, .party-phone-print, .party-email-print, .party-address-print,
    .invoice-no-print, .invoice-date-print, .due-date-print,
    .notes-print, .terms-print, .discount-print, .charges-print, .received-print,
    .item-select-print {
      display: inline !important;
      font-size: 9pt;
      color: #000;
      border: none !important;
      background: none !important;
      padding: 0;
      margin: 0;
    }
    .row {
      page-break-inside: avoid;
      margin: 0;
    }
    .invoice-header {
      margin-bottom: 5px;
    }
    .card-body > .row > div {
      display: block;
      width: 100%;
    }
    .card-body > .row > div > .card {
      margin-bottom: 3px;
    }
    p, label {
      margin: 0;
      font-size: 9pt;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Check if jQuery and Select2 are loaded
  if (typeof jQuery === 'undefined') {
    console.error('jQuery is not loaded');
    return;
  }
  if (!jQuery.fn.select2) {
    console.error('Select2 is not loaded');
  }

  const itemTable = document.querySelector('#itemTable tbody');
  const addItemBtn = document.querySelector('#addItemBtn');
  let itemCount = 0;
  const items = [
    {% for item in items %}
    {
      id: {{ item.id|default_if_none:'null' }},
      name: "{{ item.item_name|escapejs|default_if_none:'' }}",
      type: "{{ item.item_type|default_if_none:'' }}",
      hsn_sac: "{{ item.hsn_sac_code|default_if_none:''|escapejs }}",
      sale_price: {{ item.sale_price|floatformat:2|default_if_none:'0.00' }},
      batch_number: {% if item.item_type == 'product' %}"{{ item.batch_number|default_if_none:''|escapejs }}"{% else %}""{% endif %},
      expiry_date: {% if item.item_type == 'product' %}"{{ item.expiry_date|date:'Y-m-d'|default_if_none:'' }}"{% else %}""{% endif %},
      gst_rate: "{{ item.gst_rate|default_if_none:'0'|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% empty %}
    []
    {% endfor %}
  ];
  console.log('Items loaded:', items); // Debug: Check items array

  function addItemRow(itemId = '') {
    itemCount++;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${itemCount}</td>
      <td>
        <select class="form-control form-control-sm item-select" name="items[${itemCount-1}][item_id]" required>
          <option value="">Select Item</option>
          ${items.map(item => `<option value="${item.id}" data-price="${item.sale_price}" data-hsn="${item.hsn_sac}" data-batch="${item.batch_number}" data-expiry="${item.expiry_date}" data-gst="${item.gst_rate}" data-name="${item.name}">${item.name} (${item.type})</option>`).join('')}
        </select>
        <span class="item-select-print d-none d-print-block"></span>
      </td>
      <td><input type="text" class="form-control form-control-sm hsn_sac" name="items[${itemCount-1}][hsn_sac]" readonly></td>
      <td><input type="text" class="form-control form-control-sm batch_number" name="items[${itemCount-1}][batch_number]" readonly></td>
      <td><input type="text" class="form-control form-control-sm expiry_date" name="items[${itemCount-1}][expiry_date]" readonly></td>
      <td><input type="number" class="form-control form-control-sm quantity" name="items[${itemCount-1}][quantity]" value="1" min="1" required></td>
      <td><input type="number" class="form-control form-control-sm price" name="items[${itemCount-1}][price]" readonly></td>
      <td><input type="number" class="form-control form-control-sm discount" name="items[${itemCount-1}][discount]" value="0" step="0.01" min="0"></td>
      <td><input type="number" class="form-control form-control-sm tax" name="items[${itemCount-1}][tax_amount]" readonly></td>
      <td><input type="number" class="form-control form-control-sm amount" name="items[${itemCount-1}][amount]" readonly></td>
      <td class="d-print-none"><button type="button" class="btn btn-danger btn-sm remove-item"><i class="fas fa-trash"></i></button></td>
    `;
    itemTable.appendChild(row);
    const select = row.querySelector('.item-select');
    
    // Initialize Select2 if available, else use native select
    if (typeof jQuery.fn.select2 === 'function') {
      $(select).select2({ width: '100%' });
      if (itemId) {
        select.value = itemId;
        $(select).trigger('change');
      }
    } else {
      console.warn('Select2 not available, using native select');
      if (itemId) {
        select.value = itemId;
        select.dispatchEvent(new Event('change'));
      }
    }
    
    updateRow(row);
  }

  function updateRow(row) {
    const select = row.querySelector('.item-select');
    const hsn = row.querySelector('.hsn_sac');
    const batch = row.querySelector('.batch_number');
    const expiry = row.querySelector('.expiry_date');
    const price = row.querySelector('.price');
    const quantity = row.querySelector('.quantity');
    const discount = row.querySelector('.discount');
    const tax = row.querySelector('.tax');
    const amount = row.querySelector('.amount');
    const itemPrint = row.querySelector('.item-select-print');

    select.addEventListener('change', () => {
      console.log('Item selected:', select.value); // Debug: Check selected value
      const selectedOption = select.options[select.selectedIndex];
      const selected = items.find(item => item.id == select.value);
      if (selected && selectedOption) {
        console.log('Selected item data:', selected); // Debug: Log item data
        itemPrint.textContent = selected.name || '';
        hsn.value = selected.hsn_sac || '';
        batch.value = selected.batch_number || '';
        expiry.value = selected.expiry_date || '';
        price.value = parseFloat(selected.sale_price || 0).toFixed(2);
        updateRowTotals(row);
      } else {
        console.log('No item selected, clearing fields'); // Debug
        itemPrint.textContent = '';
        hsn.value = batch.value = expiry.value = price.value = tax.value = amount.value = '';
      }
      updateTotals();
    });

    quantity.addEventListener('input', () => {
      console.log('Quantity changed:', quantity.value); // Debug
      updateRowTotals(row);
    });
    discount.addEventListener('input', () => {
      console.log('Discount changed:', discount.value); // Debug
      updateRowTotals(row);
    });

    function updateRowTotals() {
      const selected = items.find(item => item.id == select.value);
      if (selected) {
        const qty = parseFloat(quantity.value) || 0;
        const disc = parseFloat(discount.value) || 0;
        const priceVal = parseFloat(selected.sale_price) || 0;
        const taxRate = parseFloat(selected.gst_rate.replace(/[^0-9.]/g, '')) / 100 || 0;
        tax.value = ((qty * priceVal - disc) * taxRate).toFixed(2);
        amount.value = ((qty * priceVal - disc) * (1 + taxRate)).toFixed(2);
        console.log('Row totals:', { qty, priceVal, disc, tax: tax.value, amount: amount.value }); // Debug
        updateTotals();
      }
    }
  }

  function updateTotals() {
    let subtotal = 0, totalTax = 0;
    document.querySelectorAll('#itemTable tbody tr').forEach(row => {
      const qty = parseFloat(row.querySelector('.quantity').value) || 0;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const disc = parseFloat(row.querySelector('.discount').value) || 0;
      const tax = parseFloat(row.querySelector('.tax').value) || 0;
      subtotal += qty * price - disc;
      totalTax += tax;
    });

    const discount = parseFloat(document.querySelector('#totalDiscount').value) || 0;
    const charges = parseFloat(document.querySelector('#additionalCharges').value) || 0;
    const taxable = subtotal - discount + charges;
    const total = taxable + totalTax;
    const received = parseFloat(document.querySelector('#amountReceived').value) || 0;

    document.querySelector('#subtotal').textContent = `₹ ${subtotal.toFixed(2)}`;
    document.querySelector('#taxableAmount').textContent = `₹ ${taxable.toFixed(2)}`;
    document.querySelector('#totalTax').textContent = `₹ ${totalTax.toFixed(2)}`;
    document.querySelector('#totalAmount').textContent = `₹ ${total.toFixed(2)}`;
    document.querySelector('#balanceAmount').textContent = `₹ ${(total - received).toFixed(2)}`;
    document.querySelector('.discount-print').textContent = discount.toFixed(2);
    document.querySelector('.charges-print').textContent = charges.toFixed(2);
    document.querySelector('.received-print').textContent = received.toFixed(2);
    console.log('Totals updated:', { subtotal, taxable, totalTax, total, received, balance: total - received }); // Debug
  }

  addItemBtn.addEventListener('click', () => addItemRow());

  document.querySelector('#itemTable').addEventListener('click', e => {
    if (e.target.closest('.remove-item')) {
      e.target.closest('tr').remove();
      itemCount--;
      updateTotals();
    }
  });

  document.querySelector('#barcode').addEventListener('input', function() {
    const item = items.find(i => i.hsn_sac === this.value || i.batch_number === this.value);
    if (item) {
      console.log('Barcode matched item:', item); // Debug
      addItemRow(item.id);
      this.value = '';
    }
  });

  ['totalDiscount', 'additionalCharges', 'amountReceived'].forEach(id => {
    const input = document.querySelector(`#${id}`);
    input.addEventListener('input', () => {
      console.log(`${id} changed:`, input.value); // Debug
      updateTotals();
      document.querySelector(`.${id}-print`).textContent = input.value || '0.00';
    });
  });

  ['partyName', 'partyPhone', 'partyEmail', 'partyAddress', 'invoiceNo', 'invoiceDate', 'dueDate', 'notes', 'terms'].forEach(id => {
    const input = document.querySelector(`#${id}`);
    if (input) {
      input.addEventListener('input', () => {
        document.querySelector(`.${id.toLowerCase()}-print`).textContent = input.value || '____________________';
      });
    }
  });

  // Initialize with one row
  if (items.length > 0) {
    addItemRow();
  } else {
    console.warn('No items available to populate dropdown');
  }
});
</script>

{% include 'footer_link.html' %}


sidebar
{% load static %}
<style>
    /* Sidebar Enhancements */
    .main-sidebar {
        background: linear-gradient(135deg, #1a2a3a 0%, #0d1721 100%);
    }
    
    .nav-header {
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
        letter-spacing: 1px;
    }
    
    .nav-link {
        border-left: 3px solid transparent;
        margin-bottom: 2px;
    }
    
    .nav-link.active, .nav-link:hover {
        background: rgba(255,255,255,0.05);
        border-left-color: #4e73df;
    }
    
    .nav-item > .nav-link > i {
        min-width: 25px;
        text-align: center;
    }
    
    .brand-link {
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .user-panel {
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
</style>
<!-- Main Sidebar Container -->
<aside class="main-sidebar sidebar-dark-primary elevation-4" style="background: #1a2a3a;">
    <!-- Brand Logo -->
    <a href="{% url 'dash' %}" class="brand-link text-center" style="background: rgba(255,255,255,0.1);">
        <img src="https://camo.githubusercontent.com/6907519551f9e6948c61eafb1cead2f198f252162570317067efeb6f6f46b448/68747470733a2f2f69636f6e2d6c6962726172792e636f6d2f696d616765732f6572702d73797374656d2d69636f6e2f6572702d73797374656d2d69636f6e2d392e6a7067" alt="ERP Logo" class="brand-image" style="opacity: .9; width: 30px; height: 30px;">
        <span class="brand-text font-weight-light" style="font-size: 1.1rem;">ERP System</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Sidebar User Panel -->
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
                <img src="{% static '../static/dist/img/user1.jpg' %}" class="img-circle elevation-2" alt="User Image">
            </div>
            <div class="info">
                {% if 'email' in request.session %}
                <a href="#" class="d-block text-white">{{add.email}}</a>
                {% endif %}
            </div>
        </div>

        <!-- Quick Action Button -->
        <!-- <div class="px-3 mb-3">
            <a href="{% url 'Create_Sale' %}" class="btn btn-success btn-block btn-sm">
                <i class="fas fa-plus-circle mr-1"></i> New Sale
            </a>
        </div> -->

        <!-- Sidebar Menu -->
        <nav class="mt-2">
            <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                <!-- Superadmin Dashboard -->
                {% if add.role ==  "superadmin"%}
                <li class="nav-item">
                    <a href="{% url 'superadmin_dashboard' %}"
                        class="nav-link {% if request.resolver_match.url_name == 'superadmin_dashboard' %}active{% endif %}">
                        <i class="nav-icon fas fa-user-shield"></i>
                        <p>Superadmin</p>
                    </a>
                </li>
                {% endif %}
                <!-- Dashboard -->
                <li class="nav-item">
                    <a href="{% url 'dash' %}" class="nav-link {% if request.path == '/' %}active{% endif %}">
                        <i class="nav-icon fas fa-tachometer-alt"></i>
                        <p>Dashboard</p>
                    </a>
                </li>

                <!-- Core Modules -->
                <li class="nav-header text-uppercase text-muted">Core Modules</li>

                <!-- Party Modules -->
                <!-- <li class="nav-item">
                    <a href="{% url 'Party_list' %}" class="nav-link">
                        <i class="nav-icon fas fa-users"></i>
                        <p>Parties</p>
                    </a>
                </li> -->
                
                {% with menu_path='Party_list' %}
                {% if add.role == 'superadmin' %}
                <li class="nav-item has-treeview {% if request.resolver_match.url_name == menu_path %}menu-open{% endif %}">
                    <a href="#" class="nav-link {% if request.resolver_match.url_name == menu_path %}active{% endif %}">
                        <i class="nav-icon fas fa-users"></i><p>Parties <i class="right fas fa-angle-left"></i></p>
                    </a>
                    <ul class="nav nav-treeview">
                        {% for t in all_tenants_for_superadmin %}<li class="nav-item"><a href="{% url menu_path %}?tenant_id={{ t.id }}" class="nav-link {% if tenant.id == t.id and request.resolver_match.url_name == menu_path %}active{% endif %}"><i class="far fa-circle nav-icon"></i><p>{{ t.name }}</p></a></li>{% endfor %}
                    </ul>
                </li>
                {% else %}
                <li class="nav-item"><a href="{% url menu_path %}" class="nav-link {% if request.resolver_match.url_name == menu_path %}active{% endif %}"><i class="nav-icon fas fa-users"></i><p>Parties</p></a></li>
                {% endif %}
                {% endwith %}

                <!-- Item Modules -->
                <!-- <li class="nav-item">
                    <a href="{% url 'Item_list' %}" class="nav-link">
                        <i class="nav-icon fas fa-boxes"></i>
                        <p>Inventory Items</p>
                    </a>
                </li> -->

                {% with menu_path='Item_list' %}
                {% if add.role == 'superadmin' %}
                <li class="nav-item has-treeview {% if request.resolver_match.url_name == menu_path %}menu-open{% endif %}">
                    <a href="#" class="nav-link {% if request.resolver_match.url_name == menu_path %}active{% endif %}">
                        <i class="nav-icon fas fa-boxes"></i><p>Inventory Items <i class="right fas fa-angle-left"></i></p>
                    </a>
                    <ul class="nav nav-treeview">
                        {% for t in all_tenants_for_superadmin %}<li class="nav-item"><a href="{% url menu_path %}?tenant_id={{ t.id }}" class="nav-link {% if tenant.id == t.id and request.resolver_match.url_name == menu_path %}active{% endif %}"><i class="far fa-circle nav-icon"></i><p>{{ t.name }}</p></a></li>{% endfor %}
                    </ul>
                </li>
                {% else %}
                <li class="nav-item"><a href="{% url menu_path %}" class="nav-link {% if request.resolver_match.url_name == menu_path %}active{% endif %}"><i class="nav-icon fas fa-boxes"></i><p>Inventory Items</p></a></li>
                {% endif %}
                {% endwith %}

                <!-- <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-balance-scale"></i>
                        <p>Units of Measure</p>
                    </a>
                </li> -->

                <!-- Transactions -->
                <li class="nav-header text-uppercase text-muted">Transactions</li>

                <!-- Sales Modules -->
                <!-- <li class="nav-item">
                    <a href="{% url 'sales_list' %}" class="nav-link {% if 'sales' in request.path %}active{% endif %} ">
                        <i class="nav-icon fas fa-cash-register"></i>
                        <p>Sales</p>
                    </a>
                </li> -->
                {% with menu_path='sales_list' %}
                {% if add.role == 'superadmin' %}
                <li class="nav-item has-treeview {% if menu_path in request.path %}menu-open{% endif %}">
                    <a href="#" class="nav-link {% if menu_path in request.path %}active{% endif %}">
                        <i class="nav-icon fas fa-cash-register"></i><p>Sales <i class="right fas fa-angle-left"></i></p>
                    </a>
                    <ul class="nav nav-treeview">
                        {% for t in all_tenants_for_superadmin %}<li class="nav-item"><a href="{% url menu_path %}?tenant_id={{ t.id }}" class="nav-link {% if tenant.id == t.id and menu_path in request.path %}active{% endif %}"><i class="far fa-circle nav-icon"></i><p>{{ t.name }}</p></a></li>{% endfor %}
                    </ul>
                </li>
                {% else %}
                <li class="nav-item"><a href="{% url menu_path %}" class="nav-link {% if menu_path in request.path %}active{% endif %}"><i class="nav-icon fas fa-cash-register"></i><p>Sales</p></a></li>
                {% endif %}
                {% endwith %}

                <!-- Purchase Modules -->
                <!-- <li class="nav-item">
                    <a href="{% url 'purchase_list' %}" class="nav-link {% if 'purchase' in request.path %}active{% endif %}" class="nav-link">
                        <i class="nav-icon fas fa-shopping-cart"></i>
                        <p>Purchases</p>
                    </a>
                </li> -->

                {% with menu_path='purchase_list' %}
                {% if add.role == 'superadmin' %}
                <li class="nav-item has-treeview {% if 'purchase' in request.path %}menu-open{% endif %}">
                    <a href="#" class="nav-link {% if 'purchase' in request.path %}active{% endif %}">
                        <i class="nav-icon fas fa-shopping-cart"></i><p>Purchases <i class="right fas fa-angle-left"></i></p>
                    </a>
                    <ul class="nav nav-treeview">
                        {% for t in all_tenants_for_superadmin %}<li class="nav-item"><a href="{% url menu_path %}?tenant_id={{ t.id }}" class="nav-link {% if tenant.id == t.id and 'purchase' in request.path %}active{% endif %}"><i class="far fa-circle nav-icon"></i><p>{{ t.name }}</p></a></li>{% endfor %}
                    </ul>
                </li>
                {% else %}
                <li class="nav-item"><a href="{% url menu_path %}" class="nav-link {% if 'purchase' in request.path %}active{% endif %}"><i class="nav-icon fas fa-shopping-cart"></i><p>Purchases</p></a></li>
                {% endif %}
                {% endwith %}
                

                <!-- Inventory Management -->
                <!-- <li class="nav-header text-uppercase text-muted">Inventory</li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-warehouse"></i>
                        <p>Godown Stock</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-clipboard-check"></i>
                        <p>Stock Adjustments</p>
                    </a>
                </li> -->


                <!-- Financial -->
                <!-- <li class="nav-header text-uppercase text-muted">Financial</li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-money-bill-wave"></i>
                        <p>Expenses</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-file-invoice-dollar"></i>
                        <p>Invoicing</p>
                    </a>
                </li> -->

                <!-- Reports -->
                <li class="nav-header text-uppercase text-muted">Analysis & Reports</li>

                <!-- Vendors Performance Report -->
                {% with menu_path='vendor_performance' %}
                {% if add.role == 'superadmin' %}
                <li class="nav-item has-treeview {% if request.resolver_match.url_name == menu_path %}menu-open{% endif %}">
                    <a href="#" class="nav-link {% if request.resolver_match.url_name == menu_path %}active{% endif %}">
                        <i class="nav-icon fas fa-chart-line"></i><p>Vendor Performance <i class="right fas fa-angle-left"></i></p>
                    </a>
                    <ul class="nav nav-treeview">
                        {% for t in all_tenants_for_superadmin %}<li class="nav-item"><a href="{% url menu_path %}?tenant_id={{ t.id }}" class="nav-link {% if tenant.id == t.id and request.resolver_match.url_name == menu_path %}active{% endif %}"><i class="far fa-circle nav-icon"></i><p>{{ t.name }}</p></a></li>{% endfor %}
                    </ul>
                </li>
                {% else %}
                <li class="nav-item"><a href="{% url menu_path %}" class="nav-link {% if request.resolver_match.url_name == menu_path %}active{% endif %}"><i class="nav-icon fas fa-chart-line"></i><p>Vendor Performance</p></a></li>
                {% endif %}
                {% endwith %}

                <!-- Sales Reports -->
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-chart-line"></i>
                        <p>Sales Reports</p>
                    </a>
                </li>

                <!-- Inventory Reports -->
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-chart-pie"></i>
                        <p>Inventory Reports</p>
                    </a>
                </li>

                <!-- Financial Statements -->
                <!-- <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-file-alt"></i>
                        <p>Financial Statements</p>
                    </a>
                </li> -->

                <!-- System -->
                <li class="nav-header text-uppercase text-muted">System</li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-user-tie"></i>
                        <p>Employee Management</p>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link">
                        <i class="nav-icon fas fa-cog"></i>
                        <p>Settings</p>
                    </a>
                </li>
            </ul>
            <br><br>
        </nav>
    </div>
</aside>

3. Supercharge the Tenant Dashboard
Why this is a great option: The dashboard is the first thing users see. Now that you have more data points, you can transform it from a simple welcome page into a powerful command center with key business metrics at a glance.

How to implement it:

Enhance DashVw: Update the main dashboard view to calculate several key metrics for the logged-in tenant.

Add Dashboard Widgets: In the Dash.html template, add info boxes or cards for:

Key Sales Metrics: Revenue (This Month vs. Last Month).

Receivables: Total amount overdue from customers.

Payables: Total amount due to vendors.

Inventory Snapshot: A count of "Low Stock Items" and the total value of all stock on hand.



Next : 1 .In the sale pdf page change the default rate to unit price from the SaleItem modal 
      2. in the sale_invoice_pdf clearify the 2 discount field or add both the discount and show final discount (item discount + overall discount )

      but suppose if the total amount is 125.50 it will show as it is then the customer will always pay 125 and ignores 0.50 paisa and since the balance due is not 0 then in sale list status will show unpaid right? how to deal with that?

The Complete Workflow
The superadmin logs in and sees the Superadmin Dashboard.

They find "Company" in the "Manage Tenants" table and click the "Actions" dropdown.

They click "Manage Tenant".

They are redirected to the Tenant Dashboard for "Company". The sidebar now looks like a regular admin's sidebar. All links for Parties, Sales, etc., now work for "Company". A yellow "Exit Management" button appears in the navbar.

After they are done, they click "Exit Management" in the navbar.

They are returned to the main Superadmin Dashboard, and the sidebar links no longer point to a specific tenant.

This creates a clean, scalable, and professional workflow for your superadmin.


Next Edit purchase page to edit the purchase items


Old create sale page code
{% load static %}
{% include 'header.html' %}
{% include 'navbar.html' %}
{% include 'sidebar.html' %}

<style>
    /* === GENERAL PAGE LAYOUT === */
    .content-wrapper {
        background: #f7f9fc;
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .card-header {
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        font-weight: 600;
        color: #2d3748;
    }

    .form-label {
        font-weight: 600;
        color: #333;
    }

    .table thead th {
        background: #f1f5f9;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #dee2e6;
    }

    .btn {
        border-radius: 8px;
    }

    /* .btn-info {
        background-color: #2563eb;
        border-color: #2563eb;
    }

    .btn-info:hover {
        background-color: #1e40af;
        border-color: #1e40af;
    } */

    /* === PARTY DETAILS CARD === */
    #partyDetails {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 1rem 1.25rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        display: none;
    }

    #partyDetails strong {
        font-size: 1.05rem;
        color: #1a202c;
    }

    #partyDetails i {
        color: #4a5568;
        width: 18px;
        text-align: center;
    }

    #partyDetails span {
        color: #2d3748;
    }

    /* === PAYMENT SUMMARY === */
    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.65rem;
        font-size: 0.92em;
    }

    .summary-label {
        font-weight: 500;
        color: #2d3748;
    }

    .summary-value {
        font-weight: 600;
        color: #111827;
    }

    .summary-input {
        max-width: 120px;
        text-align: right;
    }

    .bg-warning {
        background: #fff3cd !important;
    }

    hr {
        margin: 0.75rem 0;
    }

    /* === TABLE RESPONSIVE (MOBILE) === */
    @media (max-width: 768px) {
        .items-table thead {
            display: none;
        }
        .items-table tr {
            display: block;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 10px;
            background: #fff;
        }
        .items-table td {
            display: flex;
            justify-content: space-between;
            border: none;
        }
        .items-table td::before {
            content: attr(data-label);
            font-weight: 600;
            color: #4a5568;
        }
    }
</style>

<div class="content-wrapper">
    <div class="content-header pb-0">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0 font-weight-bold text-dark">🧾 Create Sale</h4>
                <ol class="breadcrumb float-sm-right mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'dash' %}">Home</a></li>
                    <li class="breadcrumb-item active">Create Sale</li>
                </ol>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            {% if messages %}
            <div class="row">
                <div class="col-md-12">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <form method="POST" action="{% url 'Create_Sale' %}" enctype="multipart/form-data" id="saleForm">
                {% csrf_token %}

                {% if add.role == 'superadmin' %}
                <div class="form-group">
                    <label for="tenantSelect" class="form-label">Select Tenant</label>
                    <select name="tenant_id" id="tenantSelect" class="form-control" required>
                        <option value="">Select Tenant</option>
                        {% for t in tenants %}
                        <option value="{{ t.id }}" {% if t.id == tenant_id_from_url|add:0 %}selected{% endif %}>{{ t.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <div class="mb-3">
                    {% if add.role == 'superadmin' and tenant_id_from_url %}
                    <a href="{% url 'sales_list' %}?tenant_id={{ tenant_id_from_url }}" class="btn btn-info"><i class="fas fa-list mr-1"></i>View Sales List</a>
                    {% else %}
                    <a href="{% url 'sales_list' %}" class="btn btn-info"><i class="fas fa-list mr-1"></i>View Sales List</a>
                    {% endif %}
                </div>

                <div class="row">
                    <!-- LEFT SIDE -->
                    <div class="col-lg-8">
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Select Party *</label>
                                        <div class="d-flex">
                                            <select class="form-control form-control-sm" name="party_id" id="partySelect" required>
                                                <option value="">Select or Add a Party</option>
                                                {% for party in parties %}
                                                <option value="{{ party.id }}" data-email="{{ party.email }}" data-phone="{{ party.mobile_num }}" data-address="{{ party.billing_address }}" data-gst="{{ party.gst_no }}" data-pan="{{ party.pan_no }}">{{ party.party_name }}</option>
                                                {% endfor %}
                                            </select>
                                            <a href="{% url 'Create_party' %}" class="btn btn-primary btn-sm ml-2" title="Add New Party">+</a>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div id="partyDetails" class="mt-3">
                                            <strong><i class="fas fa-user mr-1 text-primary"></i> <span id="partyNameDisplay"></span></strong>
                                            <div class="mt-1"><i class="fas fa-envelope mr-1"></i><span id="partyEmailDisplay"></span></div>
                                            <div><i class="fas fa-phone mr-1"></i><span id="partyPhoneDisplay"></span></div>
                                            <div><i class="fas fa-map-marker-alt mr-1"></i><span id="partyAddressDisplay"></span></div>
                                            <div><strong>GSTIN:</strong> <span id="partyGstDisplay"></span></div>
                                        </div>
                                    </div>
                                </div>

                                <hr>

                                <h6 class="font-weight-bold mb-3">Sale Items</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered items-table" id="itemsTable">
                                        <thead>
                                            <tr>
                                                <th style="width: 20%;">Item</th>
                                                <th>Qty</th>
                                                <th>Price</th>
                                                <th>GST</th>
                                                <th>Discount</th>
                                                <th>Amount</th>
                                                <th>Delete</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsBody">
                                            <tr class="item-row">
                                                <td data-label="Item">
                                                    <select class="form-control form-control-sm item-select" name="items[0][item_id]" required>
                                                        <option value="">Select Item</option>
                                                        {% for item in items %}
                                                        <option value="{{ item.id }}" data-price="{{ item.sale_price }}" data-gst="{{ item.gst_rate }}">{{ item.item_name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                                <td data-label="Qty"><input type="number" class="form-control form-control-sm quantity" name="items[0][quantity]" min="1" value="1" required></td>
                                                <td data-label="Price"><input type="number" class="form-control form-control-sm unit-price" name="items[0][unit_price]"></td>
                                                <td data-label="GST"><input type="text" class="form-control form-control-sm gst-rate" name="items[0][gst_rate]" readonly></td>
                                                <td data-label="Discount"><input type="number" class="form-control form-control-sm discount" name="items[0][discount]" min="0" value="0" step="0.01"></td>
                                                <td data-label="Amount"><input type="number" class="form-control form-control-sm amount" name="items[0][amount]" readonly></td>
                                                <td><button type="button" class="btn btn-danger btn-sm remove-row">&times;</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <button type="button" class="btn btn-primary mr-2" id="addItem"><i class="fas fa-plus mr-1"></i>Add Item</button>
                                <button type="submit" class="btn btn-success" id="saveButton"><i class="fas fa-save mr-1"></i>Save</button>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT SIDE -->
                    <div class="col-lg-4">
                        <div class="card mb-3">
                            <div class="card-header">Invoice Details</div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Invoice No *</label>
                                    <input type="text" class="form-control form-control-sm" id="invoiceNo" name="invoice_no" value="{{ invoice_no }}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Invoice Date *</label>
                                    <input type="date" class="form-control form-control-sm" id="invoiceDate" name="invoice_date" value="{% now 'Y-m-d' %}" required>
                                </div>
                                <div class="form-group mb-0">
                                    <label>Due Date</label>
                                    <input type="date" class="form-control form-control-sm" id="dueDate" name="due_date">
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">Payment Summary</div>
                            <div class="card-body">
                                <div class="summary-row"><span class="summary-label">Subtotal</span><span class="summary-value" id="subtotal">₹ 0.00</span></div>
                                <div class="summary-row"><span class="summary-label">Discount</span><input type="number" class="form-control form-control-sm summary-input" id="totalDiscount" name="discount" value="0"></div>
                                <div class="summary-row">
                                    <input type="text" class="form-control form-control-sm" id="additionalChargesNote" name="additional_charges_note" placeholder="e.g., Additional Charges">
                                    <input type="number" class="form-control form-control-sm summary-input" id="additionalCharges" name="additional_charges" value="0">
                                </div>
                                <hr>
                                <div class="summary-row"><span class="summary-label">Taxable Amount</span><span class="summary-value" id="taxableAmount">₹ 0.00</span></div>
                                <div class="summary-row"><span class="summary-label">Total Tax</span><span class="summary-value" id="totalTax">₹ 0.00</span></div>
                                <hr>
                                <div class="summary-row" style="font-size: 1.1em;"><span class="summary-label">Total Amount</span><span class="summary-value" id="totalAmount">₹ 0.00</span></div>
                                <hr>
                                <div class="summary-row"><span class="summary-label">Amount Received</span><input type="number" class="form-control form-control-sm summary-input" id="amountReceived" name="amount_received" value="0"></div>
                                <div class="summary-row bg-warning p-2 rounded"><span class="summary-label">Balance Due</span><span class="summary-value" id="balanceAmount">₹ 0.00</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NOTES -->
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control form-control-sm" id="notes" name="notes" rows="2" placeholder="Add notes for internal use or customer..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Terms & Conditions</label>
                                <textarea class="form-control form-control-sm" id="terms" name="terms_conditions" rows="2">Goods once sold will not be taken back, unless it fulfills the conditions.</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

    
    <div id="loadingSpinner" class="spinner-overlay" style="display: none;">
        <div class="spinner-border text-light" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // This is the single, complete script for the page.

    /**
     * Converts a number into its word representation for invoices.
     */
    function numberToWords(num) {
        const a=['','one ','two ','three ','four ', 'five ','six ','seven ','eight ','nine ','ten ','eleven ','twelve ','thirteen ','fourteen ','fifteen ','sixteen ','seventeen ','eighteen ','nineteen '];const b=['', '', 'twenty','thirty','forty','fifty', 'sixty','seventy','eighty','ninety'];function inWords(n){if((n=n.toString()).length>9)return 'overflow';n=('000000000'+n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);if(!n)return'';var str='';str+=(n[1]!=0)?(a[Number(n[1])]||b[n[1][0]]+' '+a[n[1][1]])+'crore ':'';str+=(n[2]!=0)?(a[Number(n[2])]||b[n[2][0]]+' '+a[n[2][1]])+'lakh ':'';str+=(n[3]!=0)?(a[Number(n[3])]||b[n[3][0]]+' '+a[n[3][1]])+'thousand ':'';str+=(n[4]!=0)?(a[Number(n[4])]||b[n[4][0]]+' '+a[n[4][1]])+'hundred ':'';str+=(n[5]!=0)?((str!=='')?'and ':'')+(a[Number(n[5])]||b[n[5][0]]+' '+a[n[5][1]]):'';return str}const[integerPart,decimalPart]=num.toString().split('.');let words=inWords(integerPart);if(decimalPart&&parseInt(decimalPart)>0){words+=' and '+inWords(decimalPart)+' paise '}return words.trim().replace(/\s+/g,' ').charAt(0).toUpperCase()+words.trim().replace(/\s+/g,' ').slice(1)+'Only'
    }

    $(document).ready(function () {
        let rowIndex = 1;
        // The new line that gets data directly from the Django context
        let currentTenantItems = [{% for item in items %}{ id: {{ item.id }}, item_name: '{{ item.item_name|escapejs }}', sale_price: '{{ item.sale_price }}', gst_rate: '{{ item.gst_rate|default_if_none:"" }}' },{% endfor %}];
        // Stores items for the currently selected tenant

        /**
         * Updates Party/Item dropdowns with new data after an AJAX call.
         */
        function updateDropdowns(parties, items) {
            const partySelect = $('#partySelect');
            const itemSelects = $('.item-select');
            currentTenantItems = items || [];

            partySelect.empty().append('<option value="">Select or Add a Party...</option>');
            if (parties && parties.length > 0) {
                parties.forEach(party => {
                    const option = $(`<option value="${party.id}">${party.party_name}</option>`);
                    // Add all data attributes needed for the party details section
                    option.data('email', party.email || 'N/A');
                    option.data('phone', party.mobile_num || 'N/A');
                    option.data('gst', party.gst_no || 'N/A');
                    option.data('address', party.billing_address || 'N/A');
                    partySelect.append(option);
                });
            }

            itemSelects.each(function() {
                const currentItemSelect = $(this);
                currentItemSelect.empty().append('<option value="">Select Item</option>');
                if (currentTenantItems.length > 0) {
                    currentTenantItems.forEach(item => {
                        currentItemSelect.append(`<option value="${item.id}" data-price="${item.sale_price}" data-gst="${item.gst_rate || ''}">${item.item_name}</option>`);
                    });
                }
            });
            
            $('#partyDetails').slideUp();
            updateTotals();
        }

        /**
         * Fetches tenant-specific data when the superadmin selects a tenant.
         */
        $('#tenantSelect').on('change', function() {
            const tenantId = $(this).val();
            if (!tenantId) {
                updateDropdowns([], []);
                return;
            }
            $('#partySelect, .item-select').prop('disabled', true).html('<option>Loading...</option>');
            fetch(`/api/get_tenant_data/${tenantId}/`)
                .then(response => response.json())
                .then(data => {
                    $('#partySelect, .item-select').prop('disabled', false);
                    if (data.error) { alert(data.error); return; }
                    updateDropdowns(data.parties, data.items);
                })
                .catch(error => {
                    console.error("Failed to fetch tenant data:", error);
                    alert("An error occurred. Check the console.");
                    $('#partySelect, .item-select').prop('disabled', false);
                });
        });

        if ($('#tenantSelect').val()) {
            $('#tenantSelect').trigger('change');
        }

        /**
         * Calculates the total amount for a single item row.
         */
        function updateRowAmount(row) {
            const quantity = parseFloat(row.find('.quantity').val()) || 0;
            const unitPrice = parseFloat(row.find('.unit-price').val()) || 0;
            const discount = parseFloat(row.find('.discount').val()) || 0;
            const gstText = row.find('.gst-rate').val() || '0%';
            const gstRate = parseFloat(gstText.replace('%', '')) || 0;
            const taxableItemAmount = (quantity * unitPrice) - discount;
            const taxAmount = taxableItemAmount * (gstRate / 100);
            const amount = taxableItemAmount + taxAmount;
            row.find('.amount').val(amount.toFixed(2));
            updateTotals();
        }

        /**
         * Recalculates all totals in the Payment Summary section.
         */
        function updateTotals() {
            let subtotal = 0,totalItemDiscount = 0, totalTax = 0;

            // 1. Loop through each item to calculate line totals and gather data
            $('.item-row').each(function () {
                const row = $(this);
                const quantity = parseFloat(row.find('.quantity').val()) || 0;
                const unitPrice = parseFloat(row.find('.unit-price').val()) || 0;
                const itemDiscount  = parseFloat(row.find('.discount').val()) || 0;
                const gstText = row.find('.gst-rate').val() || '0%';
                const gstRate = parseFloat(gstText.replace('%','')) || 0;

                // Calculate subtotal before any discounts
                subtotal += quantity * unitPrice;

                // Keep track of the sum of all item-level discounts
                totalItemDiscount += itemDiscount;
                
                // Tax is calculated on the price after the item-level discount
                const taxableItemAmount = (quantity * unitPrice) - itemDiscount;
                totalTax += taxableItemAmount * (gstRate / 100);
            });
            // 2. Get overall invoice-level adjustments
            const overallDiscount = parseFloat($('#totalDiscount').val()) || 0;
            const additionalCharges = parseFloat($('#additionalCharges').val()) || 0;

            // 3. Calculate final summary
            // Taxable amount is the subtotal minus BOTH types of discounts
            const totalDiscount = totalItemDiscount + overallDiscount;
            const taxableAmount = subtotal - totalDiscount;
            const totalAmount = taxableAmount + totalTax + additionalCharges;
            const amountReceived = parseFloat($('#amountReceived').val()) || 0;
            const balanceAmount = totalAmount - amountReceived;

            // 4. Update the display
            $('#subtotal').text('₹ ' + subtotal.toFixed(2));
            $('#taxableAmount').text('₹ ' + taxableAmount.toFixed(2));
            $('#totalTax').text('₹ ' + totalTax.toFixed(2));
            $('#totalAmount').text('₹ ' + totalAmount.toFixed(2));
            $('#balanceAmount').text('₹ ' + balanceAmount.toFixed(2));
        }

        /**
         * Binds calculation events to inputs in the item rows.
         */
        function bindRowEvents(row) {
            const target = row ? row.find('.item-select, .quantity, .discount, .unit-price') : $(document);
            target.on('input change', '.item-select, .quantity, .discount, .unit-price', function () {
                const currentRow = $(this).closest('tr');
                // When a new item is selected from the dropdown, it populates the price.
                // But now the user can override it.
                if ($(this).hasClass('item-select')) {
                    const selectedOption = $(this).find('option:selected');
                    currentRow.find('.unit-price').val(selectedOption.data('price') || 0);
                    currentRow.find('.gst-rate').val(selectedOption.data('gst') || '');
                }
                // Any change will trigger a recalculation
                updateRowAmount(currentRow);
            });
        }

        /**
         * Shows party details when a party is selected.
         */
        $(document).on('change', '#partySelect', function () {
            const selectedOption = $(this).find('option:selected');
            if (selectedOption.val()) {
                $('#partyNameDisplay').text(selectedOption.text());
                $('#partyEmailDisplay').text(selectedOption.data('email') || 'N/A');
                $('#partyPhoneDisplay').text(selectedOption.data('phone') || 'N/A');
                $('#partyGstDisplay').text(selectedOption.data('gst') || 'N/A');
                $('#partyDetails').slideDown();
            } else {
                $('#partyDetails').slideUp();
            }
        });
        
        /**
         * Adds a new item row to the table.
         */
        $('#addItem').click(function () {
            let itemOptions = '<option value="">Select Item</option>';
            currentTenantItems.forEach(item => {
                itemOptions += `<option value="${item.id}" data-price="${item.sale_price}" data-gst="${item.gst_rate || ''}">${item.item_name}</option>`;
            });
            const rowHTML = `
              <tr class="item-row">
                <td data-label="Item"><select class="form-control form-control-sm item-select" name="items[${rowIndex}][item_id]" required>${itemOptions}</select></td>
                <td data-label="Qty"><input type="number" class="form-control form-control-sm quantity" name="items[${rowIndex}][quantity]" min="1" value="1" required></td>
                <td data-label="Price"><input type="number" class="form-control form-control-sm unit-price" name="items[${rowIndex}][unit_price]" step="0.01" min="0"></td>
                <td data-label="GST"><input type="text" class="form-control form-control-sm gst-rate" name="items[${rowIndex}][gst_rate]" readonly></td>
                <td data-label="Discount"><input type="number" class="form-control form-control-sm discount" name="items[${rowIndex}][discount]" min="0" value="0" step="0.01"></td>
                <td data-label="Amount"><input type="number" class="form-control form-control-sm amount" name="items[${rowIndex}][amount]" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row">&times;</button></td>
              </tr>`;
            $('#itemsBody').append(rowHTML);
            rowIndex++;
            bindRowEvents(); // Re-bind events for all rows
        });

        $(document).on('click', '.remove-row', function () {
            if ($('.item-row').length > 1) {
                $(this).closest('tr').remove();
                updateTotals();
            } else {
                alert("You must have at least one item.");
            }
        });
        $('#totalDiscount, #additionalCharges, #amountReceived').on('input', updateTotals);
        
        $('#saveButton').on('click', function(e) {
            e.preventDefault();
            $('#saleForm').submit();
        });

        bindRowEvents();
        updateTotals();
    });
</script>
    {% include 'footer.html' %}
    {% include 'footer_link.html' %}
</body>
</html>