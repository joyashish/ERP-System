{% load static %}
{% include 'header.html' %}
{% include 'navbar.html' %}
{% include 'sidebar.html' %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Sale</title>

    <style>
        /* Custom styles for a cleaner layout */
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9em;
        }
        .summary-label {
            font-weight: 500;
            color: var(--text-color);
        }
        .summary-value {
            font-weight: bold;
            color: var(--text-color);
        }
        .summary-input {
            max-width: 110px;
            text-align: right;
        }
        .dark-theme .bg-light {
             background-color: #2d3748 !important;
        }

        /* Responsive Item Table */
        @media (max-width: 768px) {
            .items-table thead {
                display: none;
            }
            .items-table tbody, .items-table tr, .items-table td {
                display: block;
                width: 100%;
            }
            .items-table tr {
                margin-bottom: 15px;
                border: 1px solid var(--border-color, #dee2e6);
                border-radius: 5px;
                padding: 10px;
            }
            .items-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border: none;
            }
            .items-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                font-weight: bold;
                text-align: left;
            }
            .items-table .remove-row {
                width: 100%;
                margin-top: 10px;
            }
        }

        /* Print Styles - Always light theme */
        @media print {
            body {
                background-color: #ffffff !important;
                color: #000000 !important;
                -webkit-print-color-adjust: exact; /* Ensures background colors are printed in Chrome */
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            #invoice-print {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            .invoice-header { text-align: center; margin-bottom: 20px; }
            .invoice-header h2 { margin: 0; font-size: 24px; font-weight: bold; }
            .invoice-header .company-details p { margin: 2px 0; font-size: 12px; }
            .party-details, .invoice-meta { font-size: 12px; }
            .party-details strong, .invoice-meta strong { font-weight: bold; }
            #invoice-print .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            #invoice-print .table th, #invoice-print .table td { border: 1px solid #999; padding: 8px; text-align: left; font-size: 12px; }
            #invoice-print .table th { background-color: #f2f2f2 !important; font-weight: bold; }
            #invoice-print .summary { margin-top: 20px; text-align: right; }
            #invoice-print .summary p { margin: 5px 0; font-size: 12px; }
            #invoice-print .footer { margin-top: 30px; font-size: 12px; border-top: 1px solid #ccc; padding-top: 10px; }
            #invoice-print .signature { margin-top: 50px; text-align: right; }
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div class="content-header no-print">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6"><h1 class="m-0">Create Sale</h1></div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="{% url 'dash' %}">Home</a></li>
                            <li class="breadcrumb-item active">Create Sale</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <section class="content no-print">
            <div class="container-fluid">
                {% if messages %}
                <div class="row">
                    <div class="col-md-12">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" id="saleForm" action="{% url 'Create_Sale' %}">
                    {% csrf_token %}
                    <div class="d-flex justify-content-end mb-3">
                        <button type="button" class="btn btn-info mr-2 printButton"><i class="fas fa-print"></i> Print Preview</button>
                        <button type="submit" form="saleForm" name="action" value="save" class="btn btn-success"><i class="fas fa-save"></i> Save Sale</button>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card card-primary card-outline">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="partySelect" class="font-weight-bold">Select Party *</label>
                                            <div class="d-flex">
                                                <select class="form-control form-control-sm" name="party_id" id="partySelect" required>
                                                    <option value="">Select or Add a Party...</option>
                                                    {% for party in parties %}
                                                    <option value="{{ party.id }}" data-email="{{ party.email }}" data-phone="{{ party.mobile_num }}" data-address="{{ party.billing_address }}" data-gst="{{ party.gst_no }}" data-pan="{{ party.pan_no }}">{{ party.party_name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <a href="{% url 'Create_party' %}" class="btn btn-primary btn-sm ml-2" title="Add New Party">+</a>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div id="partyDetails" class="mt-4 p-2 border rounded bg-light" style="display: none; font-size: 0.9em;">
                                                <strong><span id="partyNameDisplay"></span></strong><br>
                                                <i class="fas fa-envelope-square mr-1"></i> <span id="partyEmailDisplay"></span><br>
                                                <i class="fas fa-phone-square mr-1"></i> <span id="partyPhoneDisplay"></span><br>
                                                <strong>GSTIN:</strong> <span id="partyGstDisplay"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <h5 class="mb-3">Sale Items</h5>
                                    <div class="table-responsive">
                                        <table class="table table-bordered items-table" id="itemsTable">
                                            <thead>
                                                <tr>
                                                    <th style="width: 35%;">Item</th><th style="width: 10%;">Qty</th><th style="width: 15%;">Price</th><th style="width: 12%;">GST</th><th style="width: 13%;">Discount</th><th style="width: 15%;">Amount</th><th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="itemsBody">
                                                <tr class="item-row">
                                                    <td data-label="Item"><select class="form-control form-control-sm item-select" name="items[0][item_id]" required><option value="">Select Item</option>{% for item in items %}<option value="{{ item.id }}" data-price="{{ item.sale_price }}" data-gst="{{ item.gst_rate }}">{{ item.item_name }}</option>{% endfor %}</select></td>
                                                    <td data-label="Qty"><input type="number" class="form-control form-control-sm quantity" name="items[0][quantity]" min="1" value="1" required></td>
                                                    <td data-label="Price"><input type="number" class="form-control form-control-sm unit-price" name="items[0][unit_price]" readonly></td>
                                                    <td data-label="GST"><input type="text" class="form-control form-control-sm gst-rate" name="items[0][gst_rate]" readonly></td>
                                                    <td data-label="Discount"><input type="number" class="form-control form-control-sm discount" name="items[0][discount]" min="0" value="0" step="0.01"></td>
                                                    <td data-label="Amount"><input type="number" class="form-control form-control-sm amount" name="items[0][amount]" readonly></td>
                                                    <td><button type="button" class="btn btn-danger btn-sm remove-row">&times;</button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-sm mt-2" id="addItem"><i class="fas fa-plus"></i> Add Another Item</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card card-primary card-outline mb-3">
                                <div class="card-header"><h5 class="card-title mb-0 font-weight-bold">Invoice Details</h5></div>
                                <div class="card-body">
                                    <div class="form-group"><label>Invoice No *</label><input type="text" class="form-control form-control-sm" id="invoiceNo" name="invoice_no" value="{{ invoice_no }}" readonly></div>
                                    <div class="form-group"><label>Invoice Date *</label><input type="date" class="form-control form-control-sm" id="invoiceDate" name="invoice_date" value="{% now 'Y-m-d' %}" required></div>
                                    <div class="form-group mb-0"><label>Due Date</label><input type="date" class="form-control form-control-sm" id="dueDate" name="due_date"></div>
                                </div>
                            </div>
                            <div class="card card-primary card-outline">
                                <div class="card-header"><h5 class="card-title mb-0 font-weight-bold">Payment Summary</h5></div>
                                <div class="card-body">
                                    <div class="summary-row"><span class="summary-label">Subtotal</span><span class="summary-value" id="subtotal">₹ 0.00</span></div>
                                    <div class="summary-row"><span class="summary-label">Discount</span><input type="number" class="form-control form-control-sm summary-input" id="totalDiscount" name="discount" value="0" step="0.01" min="0"></div>
                                    <div class="summary-row"><span class="summary-label">Charges</span><input type="number" class="form-control form-control-sm summary-input" id="additionalCharges" name="additional_charges" value="0" step="0.01" min="0"></div>
                                    <hr><div class="summary-row"><span class="summary-label">Taxable Amount</span><span class="summary-value" id="taxableAmount">₹ 0.00</span></div>
                                    <div class="summary-row"><span class="summary-label">Total Tax</span><span class="summary-value" id="totalTax">₹ 0.00</span></div>
                                    <hr><div class="summary-row" style="font-size: 1.2em;"><span class="summary-label">Total Amount</span><span class="summary-value" id="totalAmount">₹ 0.00</span></div>
                                    <hr><div class="summary-row"><span class="summary-label">Amount Received</span><input type="number" class="form-control form-control-sm summary-input" id="amountReceived" name="amount_received" value="0" step="0.01" min="0"></div>
                                    <div class="summary-row bg-warning p-2 rounded text-dark"><span class="summary-label">Balance Due</span><span class="summary-value" id="balanceAmount">₹ 0.00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card card-primary card-outline mt-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6"><div class="form-group"><label>Notes</label><textarea class="form-control form-control-sm" id="notes" name="notes" rows="2" placeholder="Add notes for internal use or for the customer..."></textarea></div></div>
                                <div class="col-md-6"><div class="form-group"><label>Terms & Conditions</label><textarea class="form-control form-control-sm" id="terms" name="terms_conditions" rows="2">Goods once sold will not be taken back. Disputes subject to JHARKHAND jurisdiction.</textarea></div></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </section>
    </div>

    <div id="invoice-print" class="d-none">
      <div class="invoice-header">
        <h2>Your Company Name</h2>
        <div class="company-details">
          <p>Hazaribagh, Jharkhand, 825301</p>
          <p>Email: contact@yourcompany.com | Phone: +91 12345 67890</p>
        </div>
      </div>
      <hr>
      <h3 style="text-align:center; font-weight:bold; margin-bottom: 20px;">TAX INVOICE</h3>
      <div style="display:flex; justify-content:space-between;">
        <div class="party-details">
          <strong>Billed To:</strong><br>
          <span id="printPartyName"></span><br>
          <span id="printPartyAddress"></span><br>
          <span id="printPartyEmail"></span><br>
          <span id="printPartyPhone"></span><br>
          <strong>GSTIN:</strong> <span id="printPartyGst"></span><br>
          <strong>PAN:</strong> <span id="printPartyPan"></span>
        </div>
        <div class="invoice-meta" style="text-align:right;">
          <p><strong>Invoice No:</strong> <span id="printInvoiceNo"></span></p>
          <p><strong>Date:</strong> <span id="printInvoiceDate"></span></p>
          <p><strong>Due Date:</strong> <span id="printDueDate"></span></p>
        </div>
      </div>
      <table class="table">
        <thead><tr><th>#</th><th>Item</th><th>Quantity</th><th>Unit Price</th><th>GST</th><th>Discount</th><th>Amount</th></tr></thead>
        <tbody id="printItemsBody"></tbody>
      </table>
      <div style="display:flex; justify-content: flex-end;">
          <div class="summary" style="width:40%;">
              <p><strong>Subtotal:</strong> <span id="printSubtotal" style="float:right;"></span></p>
              <p><strong>Discount:</strong> <span id="printDiscount" style="float:right;"></span></p>
              <p><strong>Charges:</strong> <span id="printAdditionalCharges" style="float:right;"></span></p>
              <p><strong>Taxable Amount:</strong> <span id="printTaxableAmount" style="float:right;"></span></p>
              <p><strong>Total Tax:</strong> <span id="printTotalTax" style="float:right;"></span></p>
              <hr>
              <p><strong>Total Amount:</strong> <span id="printTotalAmount" style="float:right; font-weight:bold;"></span></p>
              <p><strong>Received:</strong> <span id="printAmountReceived" style="float:right;"></span></p>
              <p><strong>Balance Due:</strong> <span id="printBalanceAmount" style="float:right; font-weight:bold;"></span></p>
          </div>
      </div>
      <div class="footer">
        <p><strong>Notes:</strong> <span id="printNotes"></span></p>
        <p><strong>Terms & Conditions:</strong> <span id="printTerms"></span></p>
        <p><strong>Bank Details:</strong> A/c: 5337777943, IFSC: CBIN0281583, Bank: Central Bank of India, CHANDRI | A/c Holder: Sanuj Kumar Gupta, UPI: 9122133687@axl</p>
      </div>
      <div class="signature"><br><br><p style="border-top:1px solid #000; padding-top:5px; display:inline-block;"><strong>Authorized Signatory</strong></p></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
    $(document).ready(function () {
      let rowIndex = 1;

      function updateRowAmount(row) {
        const quantity = parseFloat(row.find('.quantity').val()) || 0;
        const unitPrice = parseFloat(row.find('.unit-price').val()) || 0;
        const discount = parseFloat(row.find('.discount').val()) || 0;
        const gstText = row.find('.gst-rate').val() || '0';
        const gstRate = parseFloat(gstText.replace('%', '')) || 0;
        
        const taxableItemAmount = (quantity * unitPrice) - discount;
        const taxAmount = taxableItemAmount * (gstRate / 100);
        const amount = taxableItemAmount + taxAmount;
        
        row.find('.amount').val(amount.toFixed(2));
        updateTotals();
      }

      function updateTotals() {
        let subtotal = 0;
        let totalTax = 0;

        $('.item-row').each(function () {
          const quantity = parseFloat($(this).find('.quantity').val()) || 0;
          const unitPrice = parseFloat($(this).find('.unit-price').val()) || 0;
          const discount = parseFloat($(this).find('.discount').val()) || 0;
          const gstText = $(this).find('.gst-rate').val() || '0';
          const gstRate = parseFloat(gstText.replace('%','')) || 0;

          const itemSubtotal = (quantity * unitPrice);
          subtotal += itemSubtotal;

          const taxableItemAmount = itemSubtotal - discount;
          totalTax += taxableItemAmount * (gstRate / 100);
        });

        const totalDiscountInput = parseFloat($('#totalDiscount').val()) || 0;
        const additionalCharges = parseFloat($('#additionalCharges').val()) || 0;
        
        const taxableAmount = subtotal - totalDiscountInput;
        const totalAmount = taxableAmount + totalTax + additionalCharges;
        const amountReceived = parseFloat($('#amountReceived').val()) || 0;
        const balanceAmount = totalAmount - amountReceived;

        $('#subtotal').text('₹ ' + subtotal.toFixed(2));
        $('#taxableAmount').text('₹ ' + taxableAmount.toFixed(2));
        $('#totalTax').text('₹ ' + totalTax.toFixed(2));
        $('#totalAmount').text('₹ ' + totalAmount.toFixed(2));
        $('#balanceAmount').text('₹ ' + balanceAmount.toFixed(2));
      }

      function bindRowEvents() {
        $('.item-select, .quantity, .discount').off('input change').on('input change', function () {
          const row = $(this).closest('tr');
          if ($(this).hasClass('item-select')) {
            const selectedOption = $(this).find('option:selected');
            row.find('.unit-price').val(selectedOption.data('price') || 0);
            row.find('.gst-rate').val(selectedOption.data('gst') ? selectedOption.data('gst') + '%' : '0%');
          }
          updateRowAmount(row);
        });
      }

      $('#partySelect').change(function () {
        const selectedOption = $(this).find('option:selected');
        if (selectedOption.val()) {
          $('#partyNameDisplay').text(selectedOption.text());
          $('#partyEmailDisplay').text(selectedOption.data('email') || 'N/A');
          $('#partyPhoneDisplay').text(selectedOption.data('phone') || 'N/A');
          $('#partyGstDisplay').text(selectedOption.data('gst') || 'N/A');
          $('#partyDetails').slideDown();
        } else {
          $('#partyDetails').slideUp();
        }
      });
      
      $('#addItem').click(function () {
        const rowHTML = `
          <tr class="item-row">
            <td data-label="Item"><select class="form-control form-control-sm item-select" name="items[${rowIndex}][item_id]" required><option value="">Select Item</option>{% for item in items %}<option value="{{ item.id }}" data-price="{{ item.sale_price }}" data-gst="{{ item.gst_rate }}">{{ item.item_name }}</option>{% endfor %}</select></td>
            <td data-label="Qty"><input type="number" class="form-control form-control-sm quantity" name="items[${rowIndex}][quantity]" min="1" value="1" required></td>
            <td data-label="Price"><input type="number" class="form-control form-control-sm unit-price" name="items[${rowIndex}][unit_price]" readonly></td>
            <td data-label="GST"><input type="text" class="form-control form-control-sm gst-rate" name="items[${rowIndex}][gst_rate]" readonly></td>
            <td data-label="Discount"><input type="number" class="form-control form-control-sm discount" name="items[${rowIndex}][discount]" min="0" value="0" step="0.01"></td>
            <td data-label="Amount"><input type="number" class="form-control form-control-sm amount" name="items[${rowIndex}][amount]" readonly></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">&times;</button></td>
          </tr>`;
        $('#itemsBody').append(rowHTML);
        rowIndex++;
        bindRowEvents();
      });

      $(document).on('click', '.remove-row', function () {
        if ($('.item-row').length > 1) {
          $(this).closest('tr').remove();
          updateTotals();
        }
      });

      $('#totalDiscount, #additionalCharges, #amountReceived').on('input', updateTotals);

      $('.printButton').click(function () {
        $('#printInvoiceNo').text($('#invoiceNo').val());
        $('#printInvoiceDate').text(new Date($('#invoiceDate').val()).toLocaleDateString('en-GB'));
        $('#printDueDate').text($('#dueDate').val() ? new Date($('#dueDate').val()).toLocaleDateString('en-GB') : 'N/A');
        
        const selectedParty = $('#partySelect option:selected');
        $('#printPartyName').text(selectedParty.text());
        $('#printPartyAddress').html((selectedParty.data('address') || '').replace(/\n/g, '<br>'));
        $('#printPartyEmail').text(selectedParty.data('email') || '');
        $('#printPartyPhone').text(selectedParty.data('phone') || '');
        $('#printPartyGst').text(selectedParty.data('gst') || 'N/A');
        $('#printPartyPan').text(selectedParty.data('pan') || 'N/A');

        $('#printItemsBody').empty();
        let itemIndex = 1;
        let totalItemDiscount = 0;
        $('.item-row').each(function () {
          const itemDiscount = parseFloat($(this).find('.discount').val()) || 0;
          totalItemDiscount += itemDiscount;
          const row = `<tr>
            <td>${itemIndex++}</td>
            <td>${$(this).find('.item-select option:selected').text()}</td>
            <td>${$(this).find('.quantity').val()}</td>
            <td>${parseFloat($(this).find('.unit-price').val()).toFixed(2)}</td>
            <td>${$(this).find('.gst-rate').val()}</td>
            <td>${itemDiscount.toFixed(2)}</td>
            <td>${parseFloat($(this).find('.amount').val()).toFixed(2)}</td>
          </tr>`;
          $('#printItemsBody').append(row);
        });

        const overallDiscount = parseFloat($('#totalDiscount').val()) || 0;
        
        $('#printSubtotal').text($('#subtotal').text());
        $('#printDiscount').text('₹ ' + overallDiscount.toFixed(2));
        $('#printAdditionalCharges').text('₹ ' + (parseFloat($('#additionalCharges').val()) || 0).toFixed(2));
        $('#printTaxableAmount').text($('#taxableAmount').text());
        $('#printTotalTax').text($('#totalTax').text());
        $('#printTotalAmount').text($('#totalAmount').text());
        $('#printAmountReceived').text('₹ ' + (parseFloat($('#amountReceived').val()) || 0).toFixed(2));
        $('#printBalanceAmount').text($('#balanceAmount').text());
        $('#printNotes').text($('#notes').val() || 'N/A');
        $('#printTerms').text($('#terms').val() || 'N/A');
        
        window.print();
      });

      // Initial setup
      bindRowEvents();
      updateTotals();
    });
    </script>
    
    {% include 'footer.html' %}
    {% include 'footer_link.html' %}
</body>
</html> 