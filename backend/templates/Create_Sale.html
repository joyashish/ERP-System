{% load static %}
{% include 'header.html' %}
{% include 'navbar.html' %}
{% include 'sidebar.html' %}

<!-- Minimal Modern (Teal accent) Create Sale Template -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
    :root{
        --bg: #f9fafb;          /* soft gray page background */
        --card: #ffffff;
        --muted: #6b7280;
        --text: #0f172a;
        --teal: #14b8a6;
        --shadow: 0 6px 18px rgba(16,24,40,0.06);
        --radius: 14px;
    }

    body {
        font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: var(--bg);
        color: var(--text);
    }

    .content-wrapper {
        padding: 28px 20px;
    }

    /* Page header */
    .content-header .breadcrumb a { color: var(--muted); }
    .page-title {
        display:flex;
        align-items:center;
        gap:12px;
        font-weight:600;
        font-size:1.25rem;
    }

    /* Cards */
    .card {
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: none;
        overflow: visible;
    }
    .card + .card { margin-top: 12px; }

    .card-header {
        background: transparent;
        border-bottom: none;
        padding: 16px 20px;
        font-weight:600;
        color:var(--text);
    }

    .card-body {
        padding: 16px 20px;
    }

    /* Form labels & inputs */
    .form-label { font-weight:600; color:var(--text); margin-bottom:6px; font-size:0.95rem; }
    .form-control { border-radius:10px; }
    .form-control:focus { box-shadow: 0 0 0 4px rgba(20,184,166,0.06); border-color: var(--teal); }

    /* Top action buttons */
    .top-actions { display:flex; gap:10px; align-items:center; margin-bottom:14px; }
    .btn {
        border-radius:10px;
        padding:8px 12px;
        font-weight:600;
        letter-spacing:0.1px;
    }
    .btn-primary { background: var(--teal); border-color: var(--teal); color: #fff; }
    .btn-primary:hover { background: #0fa693; border-color:#0fa693; }
    .btn-info { background:#0ea5b7; border-color:#0ea5b7; color:#fff; }
    .btn-success { background:#10b981; border-color:#10b981; color:#fff; }

    /* Party details card (glass-like) */
    #partyDetails {
        background: linear-gradient(180deg, rgba(255,255,255,0.72), rgba(255,255,255,0.6));
        border: 1px solid rgba(20,20,20,0.03);
        padding: 14px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(16,24,40,0.04);
        display: none;
        font-size: 0.95rem;
    }
    #partyDetails strong { display:block; font-size:1.02rem; margin-bottom:6px; color:var(--text); }
    #partyDetails .pd-row { display:flex; gap:8px; align-items:center; margin:4px 0; color:var(--muted); }
    #partyDetails i { width:18px; text-align:center; color:var(--teal); }

    /* Items table - minimal look */
    .items-table {
        border-collapse: separate;
        border-spacing: 0 8px;
        width:100%;
    }
    .items-table thead th {
        background: transparent;
        color:var(--muted);
        font-weight:600;
        padding:8px 12px;
        font-size:0.9rem;
    }
    .items-table tbody tr {
        background: #fff;
        border-radius:10px;
        box-shadow: 0 2px 6px rgba(16,24,40,0.03);
        display:table-row;
    }
    .items-table td {
        vertical-align: middle;
        padding:8px 12px;
        border: none;
        background: transparent;
    }
    .items-table .remove-row {
        min-width:36px;
        height:36px;
        line-height:20px;
        padding:0 10px;
        border-radius:8px;
    }

    /* Payment summary */
    .summary-row {
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:10px;
        font-size:0.95rem;
    }
    .summary-label { color:var(--muted); font-weight:600; }
    .summary-value { font-weight:700; color:var(--text); }
    .summary-input { max-width:100px; text-align:right; border-radius:8px; }

    .total-card {
        background: linear-gradient(180deg, #fff, #fbfffd);
        border-radius: 12px;
        padding:14px;
        box-shadow: 0 6px 18px rgba(20,20,20,0.04);
    }

    .bg-warning { background: #fff7ed !important; border-radius:8px; padding:10px; }

    /* Small screens adjustments */
    @media (max-width: 768px) {
        .card-body { padding:12px; }
        .page-title { font-size:1.05rem; }
        .items-table thead { display:none; }
        .items-table tbody, .items-table tr, .items-table td { display:block; width:100%; }
        .items-table tr { margin-bottom:10px; padding:10px; }
        .items-table td { padding:6px 0; position:relative; text-align:left; }
        .items-table td::before { content: attr(data-label); position: absolute; left:0; font-weight:600; color:var(--muted); }
    }
    /* Responsive Fix for Sale Items Table */
@media (max-width: 768px) {
  .sale-items-table {
    display: block;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .sale-items-table table {
    min-width: 600px; /* ensure table scrolls horizontally */
    width: 100%;
  }

  .sale-items-table th,
  .sale-items-table td {
    white-space: nowrap;
  }

  /* Make the buttons full-width for mobile */
  .sale-buttons .btn {
    width: 100%;
    margin-bottom: 8px;
  }
}
</style>

<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <div class="page-title">
                        <i class="fas fa-file-invoice-dollar mr-1" style="color: #0fa693;"></i>
                        Create Sale
                    </div>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'dash' %}">Home</a></li>
                        <li class="breadcrumb-item active">Create Sale</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <div id="ajaxErrorContainer"></div>

            {% if messages %}
            <div class="row">
                <div class="col-12">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">&times;</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <form method="POST" action="{% url 'Create_Sale' %}" enctype="multipart/form-data" id="saleForm">
                {% csrf_token %}

                {% if add.role == 'superadmin' %}
                <div class="form-group mb-3">
                    <label for="tenantSelect" class="form-label">Select Tenant</label>
                    <select name="tenant_id" id="tenantSelect" class="form-control" required>
                        <option value="">Select Tenant</option>
                        {% for t in tenants %}
                        <option value="{{ t.id }}" {% if t.id == tenant_id_from_url|add:0 %}selected{% endif %}>{{ t.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <div class="top-actions">
                    {% if add.role == 'superadmin' and tenant_id_from_url %}
                    <a href="{% url 'sales_list' %}?tenant_id={{ tenant_id_from_url }}" class="btn btn-info"><i class="fas fa-list mr-1"></i>View Sales List</a>
                    {% else %}
                    <a href="{% url 'sales_list' %}" class="btn btn-info"><i class="fas fa-list mr-1"></i>View Sales List</a>
                    {% endif %}
                </div>

                <div class="row">
                    <!-- LEFT COLUMN -->
                    <div class="col-lg-8">
                        <div class="card mb-3">
                            <div class="card-body">

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="partySelect" class="form-label">Select Party *</label>
                                        <div class="d-flex">
                                            <select class="form-control form-control-sm" name="party_id" id="partySelect" required>
                                                <option value="">Select or Add a Party.</option>
                                                {% for party in parties %}
                                                <option value="{{ party.id }}" data-email="{{ party.email }}" data-phone="{{ party.mobile_num }}" data-address="{{ party.billing_address }}" data-gst="{{ party.gst_no }}" data-pan="{{ party.pan_no }}">{{ party.party_name }}</option>
                                                {% endfor %}
                                            </select>
                                            <a href="{% url 'Create_party' %}" class="btn btn-primary btn-sm ml-2" title="Add New Party">+</a>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div id="partyDetails" class="mt-3">
                                            <strong> <i class="fas fa-user"></i> <span id="partyNameDisplay"></span></strong>
                                            <div class="pd-row"><i class="fas fa-envelope"></i><span id="partyEmailDisplay"></span></div>
                                            <div class="pd-row"><i class="fas fa-phone"></i><span id="partyPhoneDisplay"></span></div>
                                            <div class="pd-row"><i class="fas fa-id-badge"></i><strong style="color:var(--text); margin-left:2px">GSTIN:</strong>&nbsp;<span id="partyGstDisplay" style="font-weight:600; margin-left:6px"></span></div>
                                        </div>
                                    </div>
                                </div>

                                <hr style="border-top:1px solid rgba(16,24,40,0.04); margin:16px 0;">

                                <h6 style="margin-bottom:12px; font-weight:700; color:var(--text)">Sale Items</h6>

                                <div class="sale-items-table mt-3">
                                    <table class="table align-middle" id="itemsTable">
                                        <thead>
                                            <tr>
                                                <th style="width: 20%;">Item</th>
                                                <th style="width:90px">Qty</th>
                                                <th style="width:120px">Price</th>
                                                <th style="width:90px">GST</th>
                                                <th style="width:110px">Discount</th>
                                                <th style="width:130px">Amount</th>
                                                <th style="width:40px"></th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsBody">
                                            <tr class="item-row">
                                                <td data-label="Item">
                                                    <select class="form-control form-control-sm item-select" name="items[0][item_id]" required>
                                                        <option value="">Select Item</option>
                                                        {% for item in items %}
                                                        <option value="{{ item.id }}" data-price="{{ item.sale_price }}" data-gst="{{ item.gst_rate }}">{{ item.item_name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </td>
                                                <td data-label="Qty"><input type="number" class="form-control form-control-sm quantity" name="items[0][quantity]" min="1" value="1" required></td>
                                                <td data-label="Price"><input type="number" class="form-control form-control-sm unit-price" name="items[0][unit_price]"></td>
                                                <td data-label="GST"><input type="text" class="form-control form-control-sm gst-rate" name="items[0][gst_rate]" readonly></td>
                                                <td data-label="Discount"><input type="number" class="form-control form-control-sm discount" name="items[0][discount]" min="0" value="0" step="0.01"></td>
                                                <td data-label="Amount"><input type="number" class="form-control form-control-sm amount" name="items[0][amount]" readonly></td>
                                                <td><button type="button" class="btn btn-danger btn-sm remove-row">&times;</button></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="mt-3 d-flex gap-2">
                                    <button type="button" class="btn btn-primary mr-2" id="addItem"><i class="fas fa-plus mr-1"></i> Add Another Item</button>
                                    <button type="submit" class="btn btn-success mr-2" id="saveButton"><i class="fas fa-save mr-1"></i> Save</button>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN -->
                    <div class="col-lg-4">
                        <div class="card mb-3">
                            <div class="card-header">Invoice Details</div>
                            <div class="card-body">
                                <div class="form-group"><label class="form-label">Invoice No *</label><input type="text" class="form-control form-control-sm" id="invoiceNo" name="invoice_no" value="{{ invoice_no }}" readonly></div>
                                <div class="form-group"><label class="form-label">Invoice Date *</label><input type="date" class="form-control form-control-sm" id="invoiceDate" name="invoice_date" value="{% now 'Y-m-d' %}" required></div>
                                <div class="form-group mb-0"><label class="form-label">Due Date</label><input type="date" class="form-control form-control-sm" id="dueDate" name="due_date"></div>
                            </div>
                        </div>

                        <div class="card total-card">
                            <div class="card-header" style="padding-bottom:6px;">Payment Summary</div>
                            <div class="card-body">
                                <div class="summary-row"><span class="summary-label">Subtotal</span><span class="summary-value" id="subtotal">â‚¹ 0.00</span></div>

                                <div class="summary-row">
                                    <span class="summary-label">Discount</span>
                                    <input type="number" class="form-control form-control-sm summary-input" id="totalDiscount" name="discount" value="0" step="0.01" min="0">
                                </div>

                                <div class="summary-row">
                                    <input type="text" class="form-control form-control-sm" id="additionalChargesNote" name="additional_charges_note" placeholder="Additional Charges (note)">
                                    <input type="number" class="form-control form-control-sm summary-input" id="additionalCharges" name="additional_charges" value="0" step="0.01" min="0">
                                </div>

                                <hr style="margin:10px 0; border-top:1px solid rgba(16,24,40,0.04)">

                                <div class="summary-row"><span class="summary-label">Taxable Amount</span><span class="summary-value" id="taxableAmount">â‚¹ 0.00</span></div>
                                <div class="summary-row"><span class="summary-label">Total Tax</span><span class="summary-value" id="totalTax">â‚¹ 0.00</span></div>

                                <hr style="margin:10px 0; border-top:1px solid rgba(16,24,40,0.04)">

                                <div class="summary-row" style="font-size:1.05rem"><span class="summary-label">Total Amount</span><span class="summary-value" id="totalAmount">â‚¹ 0.00</span></div>

                                <hr style="margin:10px 0; border-top:1px solid rgba(16,24,40,0.04)">

                                <div class="summary-row"><span class="summary-label">Amount Received</span><input type="number" class="form-control form-control-sm summary-input" id="amountReceived" name="amount_received" value="0" step="0.01" min="0"></div>

                                <div class="summary-row bg-warning" style="margin-top:10px;"><span class="summary-label">Balance Due</span><span class="summary-value" id="balanceAmount">â‚¹ 0.00</span></div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control form-control-sm" id="notes" name="notes" rows="2" placeholder="Add notes for internal use or for the customer..."></textarea>
                            </div>
                            <div class="col-md-6 mb-2">
                                <label class="form-label">Terms & Conditions</label>
                                <textarea class="form-control form-control-sm" id="terms" name="terms_conditions" rows="2">Goods once sold will not be taken back, unless it fulfills the conditions</textarea>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </section>
</div>

<!-- Keep your original JS exactly as-is to preserve behavior -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function () {
    let rowIndex = 1;

    // --- Load all available items for the tenant from Django context ---
    let currentTenantItems = [
        {% for item in items %}
            {
                id: {{ item.id }},
                item_name: '{{ item.item_name|escapejs }}',
                sale_price: '{{ item.sale_price }}',
                gst_rate: '{{ item.gst_rate|default_if_none:"" }}'
            },
        {% endfor %}
    ];

    /**
     * ðŸ”¢ Converts a numeric value into words (for amount in words display)
     */
    function numberToWords(num) {
        const a=['','one ','two ','three ','four ','five ','six ','seven ','eight ','nine ','ten ','eleven ','twelve ','thirteen ','fourteen ','fifteen ','sixteen ','seventeen ','eighteen ','nineteen '];
        const b=['', '', 'twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
        function inWords(n){
            if((n=n.toString()).length>9)return'overflow';
            n=('000000000'+n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if(!n)return'';
            let str='';
            str+=(n[1]!=0)?(a[Number(n[1])]||b[n[1][0]]+' '+a[n[1][1]])+'crore ':'';
            str+=(n[2]!=0)?(a[Number(n[2])]||b[n[2][0]]+' '+a[n[2][1]])+'lakh ':'';
            str+=(n[3]!=0)?(a[Number(n[3])]||b[n[3][0]]+' '+a[n[3][1]])+'thousand ':'';
            str+=(n[4]!=0)?(a[Number(n[4])]||b[n[4][0]]+' '+a[n[4][1]])+'hundred ':'';
            str+=(n[5]!=0)?((str!=='')?'and ':'')+(a[Number(n[5])]||b[n[5][0]]+' '+a[n[5][1]]):'';
            return str;
        }
        const [integerPart, decimalPart] = num.toString().split('.');
        let words = inWords(integerPart);
        if(decimalPart && parseInt(decimalPart)>0){
            words+=' and '+inWords(decimalPart)+' paise ';
        }
        return words.trim().replace(/\s+/g,' ').charAt(0).toUpperCase()+
               words.trim().replace(/\s+/g,' ').slice(1)+'Only';
    }

    /**
     * ðŸ”„ Updates totals whenever any relevant input changes
     */
    function updateTotals() {
        let subtotal = 0, totalItemDiscount = 0, totalTax = 0;
        $('.item-row').each(function () {
            const row = $(this);
            const qty = parseFloat(row.find('.quantity').val()) || 0;
            const price = parseFloat(row.find('.unit-price').val()) || 0;
            const discount = parseFloat(row.find('.discount').val()) || 0;
            const gstText = row.find('.gst-rate').val() || '0%';
            const gst = parseFloat(gstText.replace('%','')) || 0;

            subtotal += qty * price;
            totalItemDiscount += discount;

            const taxable = (qty * price) - discount;
            totalTax += taxable * (gst / 100);
        });

        const overallDiscount = parseFloat($('#totalDiscount').val()) || 0;
        const addCharges = parseFloat($('#additionalCharges').val()) || 0;
        const totalDiscount = totalItemDiscount + overallDiscount;
        const taxableAmount = subtotal - totalDiscount;
        const totalAmount = taxableAmount + totalTax + addCharges;
        const amountReceived = parseFloat($('#amountReceived').val()) || 0;
        const balance = totalAmount - amountReceived;

        $('#subtotal').text('â‚¹ ' + subtotal.toFixed(2));
        $('#taxableAmount').text('â‚¹ ' + taxableAmount.toFixed(2));
        $('#totalTax').text('â‚¹ ' + totalTax.toFixed(2));
        $('#totalAmount').text('â‚¹ ' + totalAmount.toFixed(2));
        $('#balanceAmount').text('â‚¹ ' + balance.toFixed(2));
    }

    /**
     * ðŸ”¢ Updates one rowâ€™s computed amount (used whenever row inputs change)
     */
    function updateRowAmount(row) {
        const qty = parseFloat(row.find('.quantity').val()) || 0;
        const price = parseFloat(row.find('.unit-price').val()) || 0;
        const discount = parseFloat(row.find('.discount').val()) || 0;
        const gstText = row.find('.gst-rate').val() || '0%';
        const gst = parseFloat(gstText.replace('%','')) || 0;

        const taxable = (qty * price) - discount;
        const tax = taxable * (gst / 100);
        const amount = taxable + tax;

        row.find('.amount').val(amount.toFixed(2));
        updateTotals();
    }

    /**
     * ðŸ§© Binds events (input/change) to row fields for dynamic updates
     */
    function bindRowEvents(row) {
        row.find('.item-select, .quantity, .discount, .unit-price').on('input change', function() {
            const currentRow = $(this).closest('tr');
            if ($(this).hasClass('item-select')) {
                const selectedOption = $(this).find('option:selected');
                currentRow.find('.unit-price').val(selectedOption.data('price') || 0);
                currentRow.find('.gst-rate').val(selectedOption.data('gst') || '');
            }
            updateRowAmount(currentRow);
        });
    }

    /**
     * ðŸ§® Checks if the selected item is already in the table.
     * If yes: increases its quantity instead of adding duplicate.
     */
    function addOrIncrementItem(itemId) {
        let existingRow = null;
        $('.item-row').each(function () {
            const rowItemId = $(this).find('.item-select').val();
            if (rowItemId == itemId) {
                existingRow = $(this);
                return false; // break
            }
        });
        return existingRow;
    }

    /**
     * âž• Add Item button handler with duplicate prevention
     */
    $('#addItem').click(function () {
        let itemOptions = '<option value="">Select Item</option>';
        currentTenantItems.forEach(item => {
            itemOptions += `<option value="${item.id}" data-price="${item.sale_price}" data-gst="${item.gst_rate || ''}">${item.item_name}</option>`;
        });

        const rowHTML = `
          <tr class="item-row">
            <td><select class="form-control form-control-sm item-select" name="items[${rowIndex}][item_id]" required>${itemOptions}</select></td>
            <td><input type="number" class="form-control form-control-sm quantity" name="items[${rowIndex}][quantity]" min="1" value="1" required></td>
            <td><input type="number" class="form-control form-control-sm unit-price" name="items[${rowIndex}][unit_price]" step="0.01" min="0"></td>
            <td><input type="text" class="form-control form-control-sm gst-rate" name="items[${rowIndex}][gst_rate]" readonly></td>
            <td><input type="number" class="form-control form-control-sm discount" name="items[${rowIndex}][discount]" min="0" value="0" step="0.01"></td>
            <td><input type="number" class="form-control form-control-sm amount" name="items[${rowIndex}][amount]" readonly></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">&times;</button></td>
          </tr>`;

        $('#itemsBody').append(rowHTML);
        const newRow = $('#itemsBody tr:last');
        bindRowEvents(newRow);
        rowIndex++;
    });

    /**
     * ðŸ—‘ï¸ Remove row safely (keep at least one)
     */
    $(document).on('click', '.remove-row', function () {
        if ($('.item-row').length > 1) {
            $(this).closest('tr').remove();
            updateTotals();
        } else {
            alert("You must have at least one item.");
        }
    });

    /**
     * ðŸ§  When user selects an item, prevent duplicate entries
     * If already added â€” auto-increase quantity instead.
     */
    $(document).on('change', '.item-select', function () {
        const selectedItemId = $(this).val();
        if (!selectedItemId) return;

        const duplicateRow = addOrIncrementItem(selectedItemId);
        const currentRow = $(this).closest('tr');

        if (duplicateRow && duplicateRow[0] !== currentRow[0]) {
            // Increase quantity in existing row
            const existingQty = parseFloat(duplicateRow.find('.quantity').val()) || 0;
            duplicateRow.find('.quantity').val(existingQty + 1);
            updateRowAmount(duplicateRow);

            // Remove the duplicate row that was just created
            currentRow.remove();
            alert("Item already exists. Quantity increased instead.");
        } else {
            // Populate price/GST normally if unique
            const selectedOption = $(this).find('option:selected');
            currentRow.find('.unit-price').val(selectedOption.data('price') || 0);
            currentRow.find('.gst-rate').val(selectedOption.data('gst') || '');
            updateRowAmount(currentRow);
        }
    });

    /**
     * ðŸ§¾ Party selection details display
     */
    $(document).on('change', '#partySelect', function () {
        const selectedOption = $(this).find('option:selected');
        if (selectedOption.val()) {
            $('#partyNameDisplay').text(selectedOption.text());
            $('#partyEmailDisplay').text(selectedOption.data('email') || 'N/A');
            $('#partyPhoneDisplay').text(selectedOption.data('phone') || 'N/A');
            $('#partyGstDisplay').text(selectedOption.data('gst') || 'N/A');
            $('#partyDetails').slideDown();
        } else {
            $('#partyDetails').slideUp();
        }
    });

    /**
     * ðŸ’¾ Save button
     */
    $('#saveButton').on('click', function(e) {
        e.preventDefault();
        $('#saleForm').submit();
    });

    // Initialize
    bindRowEvents($('.item-row'));
    updateTotals();
});
</script>


{% include 'footer.html' %}
{% include 'footer_link.html' %}
