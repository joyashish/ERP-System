{% load static %}
{% include 'header.html' %}
{% include 'navbar.html' %}
{% include 'sidebar.html' %}
<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Sale</title> -->

    <style>
        /* Custom styles for a cleaner layout */
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9em;
        }
        .summary-label {
            font-weight: 500;
            color: var(--text-color);
        }
        .summary-value {
            font-weight: bold;
            color: var(--text-color);
        }
        .summary-input {
            max-width: 110px;
            text-align: right;
        }
        .dark-theme .bg-light {
             background-color: #2d3748 !important;
        }

        /* Responsive Item Table */
        @media (max-width: 768px) {
            .items-table thead {
                display: none;
            }
            .items-table tbody, .items-table tr, .items-table td {
                display: block;
                width: 100%;
            }
            .items-table tr {
                margin-bottom: 15px;
                border: 1px solid var(--border-color, #dee2e6);
                border-radius: 5px;
                padding: 10px;
            }
            .items-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
                border: none;
            }
            .items-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 45%;
                padding-right: 10px;
                font-weight: bold;
                text-align: left;
            }
            .items-table .remove-row {
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6"><h1 class="m-0">Create Sale</h1></div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="{% url 'dash' %}">Home</a></li>
                            <li class="breadcrumb-item active">Create Sale</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <section class="content">
            <div class="container-fluid">
                <div id="ajaxErrorContainer"></div>
                {% if messages %}
                <div class="row">
                    <div class="col-md-12">
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show msg_sec" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <form method="POST" action="{% url 'Create_Sale' %}" enctype="multipart/form-data" id="saleForm">
                    {% csrf_token %}
                    {% if add.role == 'superadmin' %}
                    <!-- Use a div with a form-group class for proper spacing and styling -->
                    <div class="form-group">
                        <label for="tenantSelect">Select Tenant</label>
                        <select name="tenant_id" id="tenantSelect" class="form-control" required>
                            <option value="">Select Tenant</option>
                            {% for t in tenants %}
                            <!-- The logic to check the ID and add 'selected' is correct -->
                            <option value="{{ t.id }}" {% if t.id == tenant_id_from_url|add:0 %}selected{% endif %}>
                                {{ t.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <br>
                    <div class="d-flex justify-content-start mb-3">
                        {% if add.role == 'superadmin' and tenant_id_from_url %}
                        <a href="{% url 'sales_list' %}?tenant_id={{ tenant_id_from_url }}" class="btn btn-info mr-2"><i
                                class="fas fa-list"></i> View Sales List</a>
                        {% else %}
                        <a href="{% url 'sales_list' %}" class="btn btn-info mr-2"><i class="fas fa-list"></i> View Sales List</a>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card card-primary card-outline">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="partySelect" class="font-weight-bold">Select Party *</label>
                                            <div class="d-flex">
                                                <select class="form-control form-control-sm" name="party_id" id="partySelect" required>
                                                    <option value="">Select or Add a Party.</option>
                                                    {% for party in parties %}
                                                    <option value="{{ party.id }}" data-email="{{ party.email }}" data-phone="{{ party.mobile_num }}" data-address="{{ party.billing_address }}" data-gst="{{ party.gst_no }}" data-pan="{{ party.pan_no }}">{{ party.party_name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <a href="{% url 'Create_party' %}" class="btn btn-primary btn-sm ml-2" title="Add New Party">+</a>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div id="partyDetails" class="mt-4 p-2 border rounded bg-light" style="display: none; font-size: 0.9em;">
                                                <strong><span id="partyNameDisplay"></span></strong><br>
                                                <i class="fas fa-envelope-square mr-1"></i> <span id="partyEmailDisplay"></span><br>
                                                <i class="fas fa-phone-square mr-1"></i> <span id="partyPhoneDisplay"></span><br>
                                                <strong>GSTIN:</strong> <span id="partyGstDisplay"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <h5 class="mb-3">Sale Items</h5>
                                    <div class="table-responsive">
                                        <table class="table table-bordered items-table" id="itemsTable">
                                            <thead>
                                                <tr>
                                                    <th style="width: 35%;">Item</th><th style="width: 10%;">Qty</th><th style="width: 15%;">Price</th><th style="width: 12%;">GST</th><th style="width: 13%;">Discount</th><th style="width: 15%;">Amount</th><th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="itemsBody">
                                                <tr class="item-row">
                                                    <td data-label="Item"><select class="form-control form-control-sm item-select" name="items[0][item_id]" required><option value="">Select Item</option>{% for item in items %}<option value="{{ item.id }}" data-price="{{ item.sale_price }}" data-gst="{{ item.gst_rate }}">{{ item.item_name }}</option>{% endfor %}</select></td>
                                                    <td data-label="Qty"><input type="number" class="form-control form-control-sm quantity" name="items[0][quantity]" min="1" value="1" required></td>
                                                    <td data-label="Price"><input type="number" class="form-control form-control-sm unit-price" name="items[0][unit_price]"></td>
                                                    <td data-label="GST"><input type="text" class="form-control form-control-sm gst-rate" name="items[0][gst_rate]" readonly></td>

                                                    <!-- Item-Level Discount (Line Item Discount): This is the discount applied to a single item in your "Sale Items" table. Saved In: The discount field of your SaleItem model. -->
                                                    <td data-label="Discount"><input type="number" class="form-control form-control-sm discount" name="items[0][discount]" min="0" value="0" step="0.01"></td>
                                                    <td data-label="Amount"><input type="number" class="form-control form-control-sm amount" name="items[0][amount]" readonly></td>
                                                    <td><button type="button" class="btn btn-danger btn-sm remove-row">&times;</button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-primary mr-2" id="addItem"><i class="fas fa-plus"></i> Add Another Item</button>
                                    <button type="submit" class="btn btn-success mr-2" id="saveButton"><i class="fas fa-save"></i> Save</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card card-primary card-outline mb-3">
                                <div class="card-header"><h5 class="card-title mb-0 font-weight-bold">Invoice Details</h5></div>
                                <div class="card-body">
                                    <div class="form-group"><label>Invoice No *</label><input type="text" class="form-control form-control-sm" id="invoiceNo" name="invoice_no" value="{{ invoice_no }}" readonly></div>
                                    <div class="form-group"><label>Invoice Date *</label><input type="date" class="form-control form-control-sm" id="invoiceDate" name="invoice_date" value="{% now 'Y-m-d' %}" required></div>
                                    <div class="form-group mb-0"><label>Due Date</label><input type="date" class="form-control form-control-sm" id="dueDate" name="due_date"></div>
                                </div>
                            </div>
                            <div class="card card-primary card-outline">
                                <div class="card-header"><h5 class="card-title mb-0 font-weight-bold">Payment Summary</h5></div>
                                <div class="card-body">
                                    <div class="summary-row"><span class="summary-label">Subtotal</span><span class="summary-value" id="subtotal">₹ 0.00</span></div>
                                    <!-- Overall Discount (Invoice Discount): This is the discount applied to the entire sale in your "Payment Summary" section. Saved In: The discount field of your Sale model. -->
                                    <div class="summary-row"><span class="summary-label">Discount</span><input type="number" class="form-control form-control-sm summary-input" id="totalDiscount" name="discount" value="0" step="0.01" min="0"></div>
                                    <div class="summary-row">
                                        <input type="text" class="form-control form-control-sm" id="additionalChargesNote" name="additional_charges_note" placeholder="e.g., Additional Charges">
                                        <input type="number" class="form-control form-control-sm summary-input" id="additionalCharges" name="additional_charges" value="0" step="0.01" min="0">
                                    </div>
                                    <hr><div class="summary-row"><span class="summary-label">Taxable Amount</span><span class="summary-value" id="taxableAmount">₹ 0.00</span></div>
                                    <div class="summary-row"><span class="summary-label">Total Tax</span><span class="summary-value" id="totalTax">₹ 0.00</span></div>
                                    <hr><div class="summary-row" style="font-size: 1.2em;"><span class="summary-label">Total Amount</span><span class="summary-value" id="totalAmount">₹ 0.00</span></div>
                                    <hr><div class="summary-row"><span class="summary-label">Amount Received</span><input type="number" class="form-control form-control-sm summary-input" id="amountReceived" name="amount_received" value="0" step="0.01" min="0"></div>
                                    <div class="summary-row bg-warning p-2 rounded text-dark"><span class="summary-label">Balance Due</span><span class="summary-value" id="balanceAmount">₹ 0.00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card card-primary card-outline mt-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6"><div class="form-group"><label>Notes</label><textarea class="form-control form-control-sm" id="notes" name="notes" rows="2" placeholder="Add notes for internal use or for the customer..."></textarea></div></div>
                                <div class="col-md-6"><div class="form-group"><label>Terms & Conditions</label><textarea class="form-control form-control-sm" id="terms" name="terms_conditions" rows="2">Goods once sold will not be taken back, unless it fulfills the conditions</textarea></div></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </section>
    </div>

</div>
    
    <div id="loadingSpinner" class="spinner-overlay" style="display: none;">
        <div class="spinner-border text-light" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // This is the single, complete script for the page.

    /**
     * Converts a number into its word representation for invoices.
     */
    function numberToWords(num) {
        const a=['','one ','two ','three ','four ', 'five ','six ','seven ','eight ','nine ','ten ','eleven ','twelve ','thirteen ','fourteen ','fifteen ','sixteen ','seventeen ','eighteen ','nineteen '];const b=['', '', 'twenty','thirty','forty','fifty', 'sixty','seventy','eighty','ninety'];function inWords(n){if((n=n.toString()).length>9)return 'overflow';n=('000000000'+n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);if(!n)return'';var str='';str+=(n[1]!=0)?(a[Number(n[1])]||b[n[1][0]]+' '+a[n[1][1]])+'crore ':'';str+=(n[2]!=0)?(a[Number(n[2])]||b[n[2][0]]+' '+a[n[2][1]])+'lakh ':'';str+=(n[3]!=0)?(a[Number(n[3])]||b[n[3][0]]+' '+a[n[3][1]])+'thousand ':'';str+=(n[4]!=0)?(a[Number(n[4])]||b[n[4][0]]+' '+a[n[4][1]])+'hundred ':'';str+=(n[5]!=0)?((str!=='')?'and ':'')+(a[Number(n[5])]||b[n[5][0]]+' '+a[n[5][1]]):'';return str}const[integerPart,decimalPart]=num.toString().split('.');let words=inWords(integerPart);if(decimalPart&&parseInt(decimalPart)>0){words+=' and '+inWords(decimalPart)+' paise '}return words.trim().replace(/\s+/g,' ').charAt(0).toUpperCase()+words.trim().replace(/\s+/g,' ').slice(1)+'Only'
    }

    $(document).ready(function () {
        let rowIndex = 1;
        // The new line that gets data directly from the Django context
        let currentTenantItems = [{% for item in items %}{ id: {{ item.id }}, item_name: '{{ item.item_name|escapejs }}', sale_price: '{{ item.sale_price }}', gst_rate: '{{ item.gst_rate|default_if_none:"" }}' },{% endfor %}];
        // Stores items for the currently selected tenant

        /**
         * Updates Party/Item dropdowns with new data after an AJAX call.
         */
        function updateDropdowns(parties, items) {
            const partySelect = $('#partySelect');
            const itemSelects = $('.item-select');
            currentTenantItems = items || [];

            partySelect.empty().append('<option value="">Select or Add a Party...</option>');
            if (parties && parties.length > 0) {
                parties.forEach(party => {
                    const option = $(`<option value="${party.id}">${party.party_name}</option>`);
                    // Add all data attributes needed for the party details section
                    option.data('email', party.email || 'N/A');
                    option.data('phone', party.mobile_num || 'N/A');
                    option.data('gst', party.gst_no || 'N/A');
                    option.data('address', party.billing_address || 'N/A');
                    partySelect.append(option);
                });
            }

            itemSelects.each(function() {
                const currentItemSelect = $(this);
                currentItemSelect.empty().append('<option value="">Select Item</option>');
                if (currentTenantItems.length > 0) {
                    currentTenantItems.forEach(item => {
                        currentItemSelect.append(`<option value="${item.id}" data-price="${item.sale_price}" data-gst="${item.gst_rate || ''}">${item.item_name}</option>`);
                    });
                }
            });
            
            $('#partyDetails').slideUp();
            updateTotals();
        }

        /**
         * Fetches tenant-specific data when the superadmin selects a tenant.
         */
        $('#tenantSelect').on('change', function() {
            const tenantId = $(this).val();
            if (!tenantId) {
                updateDropdowns([], []);
                return;
            }
            $('#partySelect, .item-select').prop('disabled', true).html('<option>Loading...</option>');
            fetch(`/api/get_tenant_data/${tenantId}/`)
                .then(response => response.json())
                .then(data => {
                    $('#partySelect, .item-select').prop('disabled', false);
                    if (data.error) { alert(data.error); return; }
                    updateDropdowns(data.parties, data.items);
                })
                .catch(error => {
                    console.error("Failed to fetch tenant data:", error);
                    alert("An error occurred. Check the console.");
                    $('#partySelect, .item-select').prop('disabled', false);
                });
        });

        if ($('#tenantSelect').val()) {
            $('#tenantSelect').trigger('change');
        }

        /**
         * Calculates the total amount for a single item row.
         */
        function updateRowAmount(row) {
            const quantity = parseFloat(row.find('.quantity').val()) || 0;
            const unitPrice = parseFloat(row.find('.unit-price').val()) || 0;
            const discount = parseFloat(row.find('.discount').val()) || 0;
            const gstText = row.find('.gst-rate').val() || '0%';
            const gstRate = parseFloat(gstText.replace('%', '')) || 0;
            const taxableItemAmount = (quantity * unitPrice) - discount;
            const taxAmount = taxableItemAmount * (gstRate / 100);
            const amount = taxableItemAmount + taxAmount;
            row.find('.amount').val(amount.toFixed(2));
            updateTotals();
        }

        /**
         * Recalculates all totals in the Payment Summary section.
         */
        function updateTotals() {
            let subtotal = 0,totalItemDiscount = 0, totalTax = 0;

            // 1. Loop through each item to calculate line totals and gather data
            $('.item-row').each(function () {
                const row = $(this);
                const quantity = parseFloat(row.find('.quantity').val()) || 0;
                const unitPrice = parseFloat(row.find('.unit-price').val()) || 0;
                const itemDiscount  = parseFloat(row.find('.discount').val()) || 0;
                const gstText = row.find('.gst-rate').val() || '0%';
                const gstRate = parseFloat(gstText.replace('%','')) || 0;

                // Calculate subtotal before any discounts
                subtotal += quantity * unitPrice;

                // Keep track of the sum of all item-level discounts
                totalItemDiscount += itemDiscount;
                
                // Tax is calculated on the price after the item-level discount
                const taxableItemAmount = (quantity * unitPrice) - itemDiscount;
                totalTax += taxableItemAmount * (gstRate / 100);
            });
            // 2. Get overall invoice-level adjustments
            const overallDiscount = parseFloat($('#totalDiscount').val()) || 0;
            const additionalCharges = parseFloat($('#additionalCharges').val()) || 0;

            // 3. Calculate final summary
            // Taxable amount is the subtotal minus BOTH types of discounts
            const totalDiscount = totalItemDiscount + overallDiscount;
            const taxableAmount = subtotal - totalDiscount;
            const totalAmount = taxableAmount + totalTax + additionalCharges;
            const amountReceived = parseFloat($('#amountReceived').val()) || 0;
            const balanceAmount = totalAmount - amountReceived;

            // 4. Update the display
            $('#subtotal').text('₹ ' + subtotal.toFixed(2));
            $('#taxableAmount').text('₹ ' + taxableAmount.toFixed(2));
            $('#totalTax').text('₹ ' + totalTax.toFixed(2));
            $('#totalAmount').text('₹ ' + totalAmount.toFixed(2));
            $('#balanceAmount').text('₹ ' + balanceAmount.toFixed(2));
        }

        /**
         * Binds calculation events to inputs in the item rows.
         */
        function bindRowEvents(row) {
            const target = row ? row.find('.item-select, .quantity, .discount, .unit-price') : $(document);
            target.on('input change', '.item-select, .quantity, .discount, .unit-price', function () {
                const currentRow = $(this).closest('tr');
                // When a new item is selected from the dropdown, it populates the price.
                // But now the user can override it.
                if ($(this).hasClass('item-select')) {
                    const selectedOption = $(this).find('option:selected');
                    currentRow.find('.unit-price').val(selectedOption.data('price') || 0);
                    currentRow.find('.gst-rate').val(selectedOption.data('gst') || '');
                }
                // Any change will trigger a recalculation
                updateRowAmount(currentRow);
            });
        }

        /**
         * Shows party details when a party is selected.
         */
        $(document).on('change', '#partySelect', function () {
            const selectedOption = $(this).find('option:selected');
            if (selectedOption.val()) {
                $('#partyNameDisplay').text(selectedOption.text());
                $('#partyEmailDisplay').text(selectedOption.data('email') || 'N/A');
                $('#partyPhoneDisplay').text(selectedOption.data('phone') || 'N/A');
                $('#partyGstDisplay').text(selectedOption.data('gst') || 'N/A');
                $('#partyDetails').slideDown();
            } else {
                $('#partyDetails').slideUp();
            }
        });
        
        /**
         * Adds a new item row to the table.
         */
        $('#addItem').click(function () {
            let itemOptions = '<option value="">Select Item</option>';
            currentTenantItems.forEach(item => {
                itemOptions += `<option value="${item.id}" data-price="${item.sale_price}" data-gst="${item.gst_rate || ''}">${item.item_name}</option>`;
            });
            const rowHTML = `
              <tr class="item-row">
                <td data-label="Item"><select class="form-control form-control-sm item-select" name="items[${rowIndex}][item_id]" required>${itemOptions}</select></td>
                <td data-label="Qty"><input type="number" class="form-control form-control-sm quantity" name="items[${rowIndex}][quantity]" min="1" value="1" required></td>
                <td data-label="Price"><input type="number" class="form-control form-control-sm unit-price" name="items[${rowIndex}][unit_price]" step="0.01" min="0"></td>
                <td data-label="GST"><input type="text" class="form-control form-control-sm gst-rate" name="items[${rowIndex}][gst_rate]" readonly></td>
                <td data-label="Discount"><input type="number" class="form-control form-control-sm discount" name="items[${rowIndex}][discount]" min="0" value="0" step="0.01"></td>
                <td data-label="Amount"><input type="number" class="form-control form-control-sm amount" name="items[${rowIndex}][amount]" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row">&times;</button></td>
              </tr>`;
            $('#itemsBody').append(rowHTML);
            rowIndex++;
            bindRowEvents(); // Re-bind events for all rows
        });

        $(document).on('click', '.remove-row', function () {
            if ($('.item-row').length > 1) {
                $(this).closest('tr').remove();
                updateTotals();
            } else {
                alert("You must have at least one item.");
            }
        });
        $('#totalDiscount, #additionalCharges, #amountReceived').on('input', updateTotals);
        
        $('#saveButton').on('click', function(e) {
            e.preventDefault();
            $('#saleForm').submit();
        });

        bindRowEvents();
        updateTotals();
    });
</script>
    {% include 'footer.html' %}
    {% include 'footer_link.html' %}
</body>
</html>