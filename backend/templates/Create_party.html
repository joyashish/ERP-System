{% include 'header.html' %}
{% include 'navbar.html' %}
{% include 'sidebar.html' %}
{% load static %}

<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6"><h1 class="m-0">Create Party</h1></div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'dash' %}">Home</a></li>
                        <li class="breadcrumb-item active">Create Party</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="card form-card">
                        <div class="card-header"><h3 class="card-title">Party Information</h3></div>
                        <div class="card-body">
                            {% if messages %}{% for message in messages %}<div class="alert alert-{{ message.tags }} alert-dismissible fade show msg_sec" role="alert"><i class="fas fa-check-circle"></i>&nbsp;&nbsp;{{message}}<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>{% endfor %}{% endif %}
                            
                            <form action="" method="POST">
                                {% csrf_token %}
                                {% if add.role == 'superadmin' %}<div class="form-group"><label for="tenantSelect">Select Tenant</label><select name="tenant_id" id="tenantSelect" class="form-control" required><option value="">Select Tenant</option>{% for t in tenants %}<option value="{{ t.id }}" {% if t.id == tenant_id_from_url|add:0 %}selected{% endif %}>{{ t.name }}</option>{% endfor %}</select></div>{% endif %}
                                
                                <h5 class="section-header">General Details</h5>
                                <div class="form-row">
                                    <div class="form-group col-md-4"><label for="partyName">Party Name</label><input type="text" id="partyName" class="form-control" name="pname" placeholder="Enter Party Name" required></div>
                                    <div class="form-group col-md-4"><label for="mobileNumber">Mobile Number</label><input type="tel" id="mobileNumber" class="form-control" name="pnum" placeholder="Enter Mobile No"></div>
                                    <div class="form-group col-md-4"><label for="email">Email</label><input type="email" id="email" class="form-control" name="pemail" placeholder="Enter Email"></div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-4"><label for="openingBalance">Opening Balance</label><input type="number" id="openingBalance" class="form-control" name="op_bal" placeholder="Balance"></div>
                                    <div class="form-group col-md-4"><label for="gstin">GSTIN</label><input type="text" id="gstin" class="form-control" name="gst_in" placeholder="Enter GST No"></div>
                                    <div class="form-group col-md-4"><label for="panNo">PAN Number</label><input type="text" id="panNo" class="form-control" name="pan_no" placeholder="Enter PAN No"></div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-4"><label for="partyType">Party Type</label><select id="partyType" class="form-control" name="p_type" required><option value="">Select Type</option><option value="Customer">Customer</option><option value="Supplier">Supplier</option></select></div>
                                    <div class="form-group col-md-4"><label for="partyCategory">Party Category</label><select id="partyCategory" class="form-control" name="p_category"><option value="">Select Category</option><option value="Regular">Regular</option><option value="VIP">VIP</option><option value="Wholesale">Wholesale</option></select></div>
                                </div>

                                <h5 class="section-header">Address Details</h5>
                                <div class="form-row">
                                    <div class="form-group col-md-6"><label for="billingAddress">Billing Address</label><textarea id="billingAddress" data-toggle="modal" data-target="#billingModal" class="form-control" name="billing_address" placeholder="Click to Enter Billing Address" readonly></textarea></div>
                                    <div class="form-group col-md-6"><label for="shippingAddress">Shipping Address</label><textarea id="shippingAddress" class="form-control" name="shipping_address" placeholder="Enter Shipping Address"></textarea><div class="form-check mt-2"><input type="checkbox" id="sameAsBilling" class="form-check-input"><label for="sameAsBilling" class="form-check-label">Same as Billing Address</label></div></div>
                                </div>

                                <h5 class="section-header">Credit Information</h5>
                                <div class="form-row">
                                    <div class="form-group col-md-4"><label for="creditPeriod">Credit Period (days)</label><input type="number" id="creditPeriod" class="form-control" name="credit_period" placeholder="Enter days"></div>
                                    <div class="form-group col-md-4"><label for="creditLimit">Credit Limit (â‚¹)</label><input type="number" id="creditLimit" class="form-control" name="credit_limit" placeholder="Enter amount"></div>
                                </div>

                                <div class="form-group mt-4"><button type="submit" class="btn btn-primary btn-save"><i class="fas fa-save"></i> Save Party</button></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<div class="modal fade" id="billingModal" tabindex="-1" role="dialog" aria-labelledby="billingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="billingModalLabel">Enter Billing Address</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 form-group"><label for="state">State *</label><select id="state" class="form-control"></select></div>
                    <div class="col-md-6 form-group"><label for="district">District *</label><select id="district" class="form-control" disabled></select></div>   
                </div>
                <div class="row">
                    <div class="col-md-8 form-group"><label for="city">City/Town/Village *</label><input type="text" id="city" class="form-control" placeholder="Enter City/Town/Village name"></div>
                    <div class="col-md-4 form-group"><label for="pincode">Pincode *</label><input type="text" id="pincode" class="form-control" placeholder="Enter Pincode" maxlength="6"></div>
                </div>
                <div class="row">
                    <div class="col-md-12 form-group"><label for="street1">Street Address / House No. *</label><input type="text" id="street1" class="form-control" placeholder="e.g., H/No 123, Main Road"></div>
                </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button><button type="button" class="btn btn-primary" id="saveBillingAddress">Save Address</button></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
$(document).ready(function () {
    const stateSelect = $('#state');
    const districtSelect = $('#district');

    const apiUrl = 'https://raw.githubusercontent.com/sab99r/Indian-States-And-Districts/master/states-and-districts.json';

    // 1. Fetch and Populate States
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            stateSelect.html('<option value="">Select State</option>');
            data.states.forEach(stateObj => {
                stateSelect.append(`<option value="${stateObj.state}">${stateObj.state}</option>`);
            });
        })
        .catch(error => console.error("Error fetching states:", error));

    // 2. Handle State Change to Populate Districts
    stateSelect.on('change', function() {
        const selectedState = $(this).val();
        districtSelect.html('<option value="">Loading...</option>').prop('disabled', true);

        if (!selectedState) {
            districtSelect.html('<option value="">Select State First</option>');
            return;
        }

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const stateData = data.states.find(s => s.state === selectedState);
                districtSelect.html('<option value="">Select District</option>').prop('disabled', false);
                if (stateData) {
                    stateData.districts.forEach(district => {
                        districtSelect.append(`<option value="${district}">${district}</option>`);
                    });
                }
            });
    });

    // 3. Save Address to Text Area (no change needed here)
    $("#saveBillingAddress").click(function () {
        const street = $("#street1").val();
        const city = $("#city").val();
        const district = $("#district").val();
        const state = $("#state").val();
        const pincode = $("#pincode").val();
        
        if (!street || !city || !district || !state || !pincode) {
            showAlert("Please fill all required address fields (*).");
            return;
        }

        const finalAddress = `${street}\n${city}, ${district}\n${state} - ${pincode}`;
        $("#billingAddress").val(finalAddress).trigger("input");
        $("#billingModal").modal("hide");
    });
    
    // --- Other page logic ---
    $("#sameAsBilling").change(function () { if ($(this).is(":checked")) { $("#shippingAddress").val($("#billingAddress").val()); } else { $("#shippingAddress").val(""); } });
    $("#billingAddress").on("input", function () { if ($("#sameAsBilling").is(":checked")) { $("#shippingAddress").val($(this).val()); } });
});
</script>

{% include 'footer.html' %}
{% include 'footer_link.html' %}

